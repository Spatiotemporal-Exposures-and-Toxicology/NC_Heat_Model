---
title: "add-covariates-noaa-observations"
output: html_document
date: "2023-08-03"
---

#### Libraries

```{r}
library(terra)
library(sf)

library(ggplot2)
library(ggspatial)
library(tidyterra)
library(rgeos)
library(data.table) # -- for large flat datasets
library(DT)

# -- for timeseries
library(lubridate)
library(xts)

library(purrr)
```

## Covariates addition

#### Open NOAA dataset

```{r}
aws <- data.table::fread("../input/NC-AWS-NOAA-dailysummary-20220601-20220831.csv") 
length(unique(aws$STATION))
aws <- aws[which(!(is.na(aws$TMAX)|is.na(aws$TMIN))),] 
aws$DATE <- as.Date(aws$DATE, format = "%Y-%m-%d")
length(unique(aws$STATION))

aws.ts.tn <- maditr::dcast(aws[, c('DATE', 'STATION', 'TMIN')], DATE ~ STATION) %>%
  as.xts() 
nb.na.tn <- lapply(aws.ts.tn, FUN=function(x) sum(is.na(x)))  
nb.na.tn <- as.data.frame(do.call(rbind, nb.na.tn))
nb.na.tn <- cbind(STATION = rownames(nb.na.tn), nb.na.tn)
rownames(nb.na.tn) <- 1:nrow(nb.na.tn)
names(nb.na.tn)[names(nb.na.tn) == 'V1'] <- 'nb.na.tn'

aws.ts.tx <- maditr::dcast(aws[, c('DATE', 'STATION', 'TMAX')], DATE ~ STATION) %>%
  as.xts() 
nb.na.tx <- lapply(aws.ts.tx, FUN=function(x) sum(is.na(x)))  
nb.na.tx <- as.data.frame(do.call(rbind, nb.na.tx))
nb.na.tx <- cbind(STATION = rownames(nb.na.tx), nb.na.tx)
rownames(nb.na.tx) <- 1:nrow(nb.na.tx)
names(nb.na.tx)[names(nb.na.tx) == 'V1'] <- 'nb.na.tx'

stations <- unique(aws[,c('STATION', 'NAME', 'LATITUDE', 'LONGITUDE', 'ELEVATION')])
stations <- list(stations, nb.na.tx, nb.na.tn) %>% reduce(full_join, by='STATION')
aws <- list(aws, nb.na.tx, nb.na.tn) %>% reduce(full_join, by='STATION')

# -- remove stations with >5 missing data
aws <- aws[which(aws$nb.na.tn<=5 | aws$nb.na.tx<=5),]

datatable(stations, filter = 'top')
datatable(aws[,c('STATION', 'TMAX', 'TMIN', 'nb.na.tn', 'nb.na.tx')], filter = 'top')
```

Tranform to SpatVect and add crs

```{r}
crs.wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
aws <- vect(aws, geom=c('LONGITUDE', 'LATITUDE'), crs=crs.wgs84, keepgeom=T)
stations <- vect(stations, geom=c('LONGITUDE', 'LATITUDE'), crs=crs.wgs84, keepgeom=T)
head(stations)
```

#### Open and add spatial covariates

```{r}
# -- imperviousness
imp <- rast("../input/NC_imperviousness_2019_crs-wgs84.tif")
# -- tree canopy cover
tcc <-  rast("../input/NC_tree-canopy-cover_2021_crs-wgs84.tif")
# -- building footprint 
build.fp <-  rast("../input/NC_building-footprints/NorthCarolina_sum_crs-wgs84.tif")
# -- building height
build.h <-  vect("../input/NC_building-height-by-block/NC_building-heights-by-block_crs-wgs84.shp")
# -- digital elevation model 
dem <- rast("../input/NC-DEM_crs-wgs84.tif")
```

Add space covariates

```{r}
stations.spatcov <- stations[, c('STATION')] 
stations.spatcov <- terra::extract(imp, stations.spatcov, bind=T) 
stations.spatcov <- terra::extract(tcc, stations.spatcov, fun='mean', method='bilinear', bind=T)
stations.spatcov <- terra::extract(build.fp, stations.spatcov, fun='mean', method='bilinear', bind=T) 
stations.spatcov <- terra::extract(dem, stations.spatcov, bind=T) 

# -- build.h is a vector and not a raster, bind=T doesn't work...
stations0 <- terra::extract(build.h[,c("Height_cat")], stations.spatcov) 
stations.spatcov$build.h <- stations0$Height_cat
```

#### Open and add time covariates

```{r}
stations.timecov <- stations[,c('STATION')]
era5.jja.vector.TNwmo <- rast('../input/era5_daily_reanalysis_20220601_20220831_TNwmo.tif')
era5.jja.vector.TN7am <- rast('../input/era5_daily_reanalysis_20220601_20220831_TN7am.tif')
era5.jja.vector.TN12am <- rast('../input/era5_daily_reanalysis_20220601_20220831_TN12am.tif')

era5.jja.vector.TNwmo <- project(era5.jja.vector.TNwmo, crs.wgs84)
era5.jja.vector.TN7am <- project(era5.jja.vector.TN7am, crs.wgs84)
era5.jja.vector.TN12am <- project(era5.jja.vector.TN12am, crs.wgs84)

stations.timecov.TNwmo <- terra::extract(era5.jja.vector.TNwmo, stations.timecov, bind=T) 
stations.timecov.TN7am <- terra::extract(era5.jja.vector.TN7am, stations.timecov, bind=T) 
stations.timecov.TN12am <- terra::extract(era5.jja.vector.TN12am, stations.timecov, bind=T) 

era5.jja.vector.TXwmo <- rast('../input/era5_daily_reanalysis_20220601_20220831_TXwmo.tif')
era5.jja.vector.TX7am <- rast('../input/era5_daily_reanalysis_20220601_20220831_TX7am.tif')
era5.jja.vector.TX12am <- rast('../input/era5_daily_reanalysis_20220601_20220831_TX12am.tif')

era5.jja.vector.TXwmo <- project(era5.jja.vector.TXwmo, crs.wgs84)
era5.jja.vector.TX7am <- project(era5.jja.vector.TX7am, crs.wgs84)
era5.jja.vector.TX12am <- project(era5.jja.vector.TX12am, crs.wgs84)

stations.timecov.TXwmo <- terra::extract(era5.jja.vector.TXwmo, stations.timecov, bind=T) 
stations.timecov.TX7am <- terra::extract(era5.jja.vector.TX7am, stations.timecov, bind=T) 
stations.timecov.TX12am <- terra::extract(era5.jja.vector.TX12am, stations.timecov, bind=T) 

df.stations.timecov.TNwmo <- melt(setDT(as.data.frame(stations.timecov.TNwmo)), id.vars = 'STATION', variable.name = 'DATE', value.name='TNwmo')
df.stations.timecov.TN7am <- melt(setDT(as.data.frame(stations.timecov.TN7am)), id.vars = 'STATION', variable.name = 'DATE', value.name='TN7am')
df.stations.timecov.TN12am <- melt(setDT(as.data.frame(stations.timecov.TN12am)), id.vars = 'STATION', variable.name = 'DATE', value.name='TN12am')
df.stations.timecov.TXwmo <- melt(setDT(as.data.frame(stations.timecov.TXwmo)), id.vars = 'STATION', variable.name = 'DATE', value.name='TXwmo')
df.stations.timecov.TX7am <- melt(setDT(as.data.frame(stations.timecov.TX7am)), id.vars = 'STATION', variable.name = 'DATE', value.name='TX7am')
df.stations.timecov.TX12am <- melt(setDT(as.data.frame(stations.timecov.TX12am)), id.vars = 'STATION', variable.name = 'DATE', value.name='TX12am')

df <- merge(df.stations.timecov.TNwmo, df.stations.timecov.TN7am, by=c('STATION', 'DATE'))
df <- merge(df, df.stations.timecov.TN12am, by=c('STATION', 'DATE'))
df <- merge(df, df.stations.timecov.TXwmo, by=c('STATION', 'DATE'))
df <- merge(df, df.stations.timecov.TX7am, by=c('STATION', 'DATE'))
df <- merge(df, df.stations.timecov.TX12am, by=c('STATION', 'DATE'))
```

Merge all extracted covariates to aws dataframe

```{r}
df$DATE <- as.Date(as.numeric(df$DATE), origin="2022-06-01")
aws$DATE <- as.Date(aws$DATE)
aws <- merge(df, aws, by=c('STATION','DATE'))

aws <- merge(aws, stations.spatcov, by=c('STATION'))
colnames(aws)[which(names(aws) == 'NC_imperviousness_2019')] <- 'imp'
colnames(aws)[which(names(aws) == 'NC_tree-canopy-cover_2021')] <- 'tcc'
colnames(aws)[which(names(aws) == 'NorthCarolina_sum')] <- 'build.fp'
colnames(aws)[which(names(aws) == 'Layer_1')] <- 'dem'

# -- change Fahrenheit to Celsius for TMIN and TMAX
# -- caution: initial temperature is rounded to Fahrenheit so conversion to degree 
# -- leads to ~.56 degree celcius precision
aws$TMIN <- round((aws$TMIN-32)*5/9,2)
aws$TMAX <- round((aws$TMAX-32)*5/9,2)

datatable(aws[,c('STATION', 'TMIN', 'TNwmo', 'TMAX', 'TXwmo', 'nb.na.tn', 'dem', 'imp', 'tcc', 'build.fp', 'build.h')], filter = 'top')
```

#### Save NOAA dataset with covariates

```{r}
fwrite(aws, "../input/NC-AWS-NOAA-dailysummary-20220601-20220831-space-time-covariates.csv")
```

## Investigation on differences between NOAA obs and ERA5 reanalysis

#### T_obs-T_era5 computation

```{r}
aws$dTN <- aws$TMIN-aws$TN
aws$dTX <- aws$TMAX-aws$TX
hist(aws$dTN, breaks=seq(-15,15,.5))
hist(aws$dTX, breaks=seq(-15,15,.5))
```

#### Data source extraction

7 = COOP = U.S. Cooperative Summary of the Day \-- Transmitted via WxCoder3 (NCDC DSI-3207) <https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00314>

R = USCRN =NCDC Reference Network Database (Climate Reference Network and Historical Climatology Network-Modernized) <https://www.ncei.noaa.gov/access/crn/>

U = RAWS = Remote Automatic Weather Station (RAWS) data obtained from the Western Regional Climate Center <https://wrcc.dri.edu>

W = WBAN = WBAN/ASOS Summary of the Day from NCDC's Integrated Surface Data (ISD). <https://www.ncei.noaa.gov/products/land-based-station/integrated-surface-database>

```{r}
library(stringr)
# -- add source feature
aws$source <- lapply(aws[,c('TMIN_ATTRIBUTES')], FUN=function(x) str_sub(x,-1,-1))
```

Map of difference between obs and reanalysis

```{r}
aws.plot <- aws
aws.plot$dTN <- aws.plot$TMIN - aws.plot$TN
aws.plot$dTX <- aws.plot$TMAX - aws.plot$TX
aws.plot <- aws.plot[, .(dTN = median(dTN), dTX=median(dTX)), keyby=c('STATION', 'LONGITUDE', 'LATITUDE', 'source')]

aws.plot <- vect(aws.plot, geom=c('LONGITUDE', 'LATITUDE'), crs=crs.wgs84, keepgeom=T)

nc.borders <- vect("../input/NC_county_boundary/North_Carolina_State_and_County_Boundary_Polygons.shp") 


aws.plot <- project(aws.plot, crs(nc.borders))

ggplot()+
geom_spatvector(data = aws.plot, 
             aes(fill=dTN, shape=source), 
             color='black', size=2)+
	geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = 'black', linewidth=.3, fill = NA) +
  scale_fill_stepsn(colours = c("navyblue","white", "red"), breaks=seq(-7,7,1), limits=c(-7,7))+
  scale_shape_manual(values=c(21,22,23,24), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+
  labs(
    fill = "",
    title = 'median(TN(obs)-TN(era5))',
    subtitle = ''
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
ggsave("../output/era5_observations_gap_map_TN.png", width=7, height=4, dpi=300)

ggplot()+   
geom_spatvector(data = aws.plot, 
             aes(fill=dTX, shape=source), 
             color='black', size=2)+
	geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = 'black', linewidth=.3, fill = NA) +
  scale_fill_stepsn(colours = c("navyblue","white", "red"), breaks=seq(-7,7,1), limits=c(-7,7))+
  scale_shape_manual(values=c(21,22,23,24), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+labs(
    fill = "",
    title = 'median(TX(obs)-TX(era5))',
    subtitle = ''
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
ggsave("../output/era5_observations_gap_map_TX.png", width=7, height=4, dpi=300)

aws.plot %>% count(source) %>% as.data.frame()
```

Same plot with reliable datasources only

```{r}

ggplot()+
geom_spatvector(data = aws.plot[which(!(aws.plot$source %in% c('7','U'))),], 
             aes(fill=dTN, shape=source), 
             color='black', size=2)+
	geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = 'black', linewidth=.3, fill = NA) +
  scale_fill_stepsn(colours = c("navyblue","white", "red"), breaks=seq(-7,7,1), limits=c(-7,7))+
  scale_shape_manual(values=c(21,22,23,24), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+
  labs(
    fill = "",
    title = 'median(TN(obs)-TN(era5))',
    subtitle = ''
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
ggsave("../output/era5_observations_gap_map_TN_reliable_aws.png", width=7, height=4, dpi=300)


ggplot()+   
geom_spatvector(data = aws.plot[which(!(aws.plot$source %in% c('7','U'))),], 
             aes(fill=dTX, shape=source), 
             color='black', size=2)+
	geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = 'black', linewidth=.3, fill = NA) +
  scale_fill_stepsn(colours = c("navyblue","white", "red"), breaks=seq(-7,7,1), limits=c(-7,7))+
  scale_shape_manual(values=c(21,22,23,24), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+labs(
    fill = "",
    title = 'median(TX(obs)-TX(era5))',
    subtitle = ''
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
ggsave("../output/era5_observations_gap_map_TX_reliable_aws.png", width=7, height=4, dpi=300)

```

Boxplot per station

```{r}
pTN <- ggplot(aws) +
  geom_boxplot(aes(y=dTN, x=STATION, group=STATION, color=source))+
  scale_color_manual(values=c('lightcoral','cyan3','purple','olivedrab3'), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+
  geom_hline(aes(yintercept=0), color='red')+
  geom_hline(aes(yintercept=1), linetype=2, color='blue')+
  geom_hline(aes(yintercept=-1), linetype=2, color='blue')+
  geom_hline(aes(yintercept=5), linetype=2, color='blue')+
  geom_hline(aes(yintercept=-5), linetype=2, color='blue')+
  theme(axis.text.x = element_blank())

pTX <- ggplot(aws) +
  geom_boxplot(aes(y=dTX, x=STATION, group=STATION, color=source))+
  scale_color_manual(values=c('lightcoral','cyan3','purple','olivedrab3'), labels=c('7'='COOP', 'R'='CRNHCN', 'U'='RAWS', 'W'='ISD'))+
  geom_hline(aes(yintercept=0), color='red')+
  geom_hline(aes(yintercept=1), linetype=2, color='blue')+
  geom_hline(aes(yintercept=-1), linetype=2, color='blue')+
  geom_hline(aes(yintercept=5), linetype=2, color='blue')+
  geom_hline(aes(yintercept=-5), linetype=2, color='blue')+
  theme(axis.text.x = element_blank())
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

library(ggpubr)
ggarrange(pTN, pTX, nrow=2)
ggsave("../output/error_boxplot_per_stations.png", width=15, height=7, dpi=300)
```

Regression plots

```{r}
ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[1:40])])+
  geom_point(aes(x=TMIN, y=TN), alpha=.5)+
  facet_wrap(~STATION)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[41:80])])+
  geom_point(aes(x=TMIN, y=TN), alpha=.5)+
  facet_wrap(~STATION)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[81:120])])+
  geom_point(aes(x=TMIN, y=TN), alpha=.5)+
  facet_wrap(~STATION)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[121:166])])+
  geom_point(aes(x=TMIN, y=TN), alpha=.5)+
  facet_wrap(~STATION)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)

ggplot(aws)+
  geom_point(aes(x=TMIN, y=TN), alpha=.1)+
  facet_wrap(~source)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)
ggsave("../output/scatterplot_era5_vs_obs_TN.png", width=5, height=5, dpi=300)

ggplot(aws)+
  geom_point(aes(x=TMAX, y=TX), alpha=.1)+
  facet_wrap(~source)+
  geom_abline(intercept = 0, slope = 1, color="red", linetype="dashed", size=.5)+
  geom_abline(intercept = 1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -1, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = 5, slope = 1, color="blue", linetype="dashed", size=.5)+
  geom_abline(intercept = -5, slope = 1, color="blue", linetype="dashed", size=.5)
ggsave("../output/scatterplot_era5_vs_obs_TX.png", width=5, height=5, dpi=300)
```

## Technical details for observations labels

**TMAX** -- Monthly Maximum Temperature. Average of daily maximum temperature given in Fahrenheit on PDF output. CSV output is given in Fahrenheit (default) or Celsius depending on user specification. Missing if more than 5 days within the month are missing or flagged or if more than 3 consecutive values within the month are missing or flagged. 

**TMAX_ATTRIBUTES =** M,Q,S where: 

M = GHCN-Daily Dataset Measurement Flag (values are given below in Table C) 

Q = GHCN-Daily Dataset Quality Flag (values are given below in Table D) 

S = GHCN-Daily Dataset Source Code (values are given below in Table B) 

**TMIN** -- Monthly Minimum Temperature. Average of daily minimum temperature given in Fahrenheit units on PDF output. CSV output is given in Fahrenheit (default) or Celsius units depending on user specification. Missing if more than 5 days within the month are missing or flagged or if more than 3 consecutive values within the month are missing or flagged. 

**TMIN_ATTRIBUTES =** M,Q,S where:

M = GHCN-Daily Dataset Measurement Flag (values are given below in Table C) 

Q = GHCN-Daily Dataset Quality Flag (values are given below in Table D)

S = GHCN-Daily Dataset Source Code (values are given below in Table B) 

**Table C - GHCN-Daily Dataset Measurement Flag**

Blank = no measurement information applicable 

H = represents highest or lowest hourly temperature (TMAX or TMIN) or the average of hourly values (TAVG) 

**Table D - GHCN-Daily Dataset Quality Flags (as of 1/9/2017):**

Blank = did not fail any quality assurance check 

S = failed spatial consistency check 

**Table B - GHCN-Daily Dataset Source Codes:**

7 = U.S. Cooperative Summary of the Day \-- Transmitted via WxCoder3 (NCDC DSI-3207) <https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00314>

R = NCDC Reference Network Database (Climate Reference Network and Historical Climatology Network-Modernized) <https://www.ncei.noaa.gov/access/crn/>

U = Remote Automatic Weather Station (RAWS) data obtained from the Western Regional Climate Center <https://wrcc.dri.edu>

W = WBAN/ASOS Summary of the Day from NCDC's Integrated Surface Data (ISD). <https://www.ncei.noaa.gov/products/land-based-station/integrated-surface-database>
