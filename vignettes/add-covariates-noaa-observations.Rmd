---
title: "add-covariates-noaa-observations"
output: html_document
date: "2023-08-03"
---

#### Libraries

```{r}
library(terra)
library(sf)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(rgeos)
library(data.table) # -- for large flat datasets
library(DT)
# -- for timeseries
library(lubridate)
library(xts)
library(purrr)
```

```{r}
input_path <- "../input/"
```

## Covariates addition

#### Open NOAA dataset

```{r}
aws_file <- "NC-AWS-NOAA-dailysummary-20220601-20220831.csv"
aws <- data.table::fread(paste0(input_path, aws_file))
length(unique(aws$STATION))
aws <- aws[which(!(is.na(aws$TMAX) | is.na(aws$TMIN))), ]
aws$DATE <- as.Date(aws$DATE, format = "%Y-%m-%d")
length(unique(aws$STATION))

aws_ts_tn <- maditr::dcast(
  aws[, c("DATE", "STATION", "TMIN")],
  DATE ~ STATION
) %>%
  as.xts()
nb_na_tn <- lapply(aws_ts_tn, FUN = function(x) sum(is.na(x)))
nb_na_tn <- as.data.frame(do.call(rbind, nb_na_tn))
nb_na_tn <- cbind(STATION = rownames(nb_na_tn), nb_na_tn)
rownames(nb_na_tn) <- seq_len(nrow(nb_na_tn))
names(nb_na_tn)[names(nb_na_tn) == "V1"] <- "nb_na_tn"

aws_ts_tx <- maditr::dcast(
  aws[, c("DATE", "STATION", "TMAX")],
  DATE ~ STATION
) %>%
  as.xts()
nb_na_tx <- lapply(aws_ts_tx, FUN = function(x) sum(is.na(x)))
nb_na_tx <- as.data.frame(do.call(rbind, nb_na_tx))
nb_na_tx <- cbind(STATION = rownames(nb_na_tx), nb_na_tx)
rownames(nb_na_tx) <- seq_len(nrow(nb_na_tx))
names(nb_na_tx)[names(nb_na_tx) == "V1"] <- "nb_na_tx"

stations <- unique(aws[, c(
  "STATION", "NAME", "LATITUDE", "LONGITUDE",
  "ELEVATION"
)])
stations <- list(stations, nb_na_tx, nb_na_tn) %>%
  reduce(full_join, by = "STATION")
aws <- list(aws, nb_na_tx, nb_na_tn) %>% reduce(full_join, by = "STATION")

# -- remove stations with >5 missing data
aws <- aws[which(aws$nb_na_tn <= 5 | aws$nb_na_tx <= 5), ]

datatable(stations, filter = "top")
datatable(aws[, c("STATION", "TMAX", "TMIN", "nb_na_tn", "nb_na_tx")],
  filter = "top"
)
```

Tranform to SpatVect and add crs

```{r}
aws <- vect(aws,
  geom = c("LONGITUDE", "LATITUDE"),
  crs = "EPSG:4326", keepgeom = TRUE
)
stations <- vect(stations,
  geom = c("LONGITUDE", "LATITUDE"),
  crs = "EPSG:4326", keepgeom = TRUE
)
head(stations)
```

#### Open and add spatial covariates

```{r}
# -- imperviousness
imp_file <- "NC_imperviousness_2019_crs-wgs84.tif"
imp <- rast(paste0(input_path, imp_file))
# -- tree canopy cover
tcc_file <- "NC_tree-canopy-cover_2021_crs-wgs84.tif"
tcc <- rast(paste0(input_path, tcc_file))
# -- building footprint
build_fp_file <- "NC_building-footprints/NorthCarolina_sum_crs-wgs84.tif"
build_fp <- rast(paste0(input_path, build_fp_file))
# -- building height
build_h_file <- paste0("NC_building-height-by-block/",
                       "NC_building-heights-by-block_crs-wgs84.shp")
build_h <- vect(paste0(input_path, build_h_file))
# -- digital elevation model
dem_file <- "NC-DEM_crs-wgs84.tif"
dem <- rast(paste0(input_path, dem_file))
```

Add space covariates

```{r}
aws_spatcov <- stations[, c("STATION")]
aws_spatcov <- terra::extract(imp, aws_spatcov, bind = TRUE)
aws_spatcov <- terra::extract(tcc, aws_spatcov, fun = "mean",
                              method = "bilinear", bind = TRUE)
aws_spatcov <- terra::extract(build_fp, aws_spatcov, fun = "mean",
                              method = "bilinear", bind = TRUE)
aws_spatcov <- terra::extract(dem, aws_spatcov, bind = TRUE)

# -- build_h is a vector and not a raster, bind=TRUE doesn't work...
stations0 <- terra::extract(build_h[, c("Height_cat")], aws_spatcov)
aws_spatcov$build_h <- stations0$Height_cat
```

#### Open and add time covariates

```{r}
aws_timecov <- stations[, c("STATION")]

file_era5_tnwmo <- "era5_daily_reanalysis_20220601_20220831_TNwmo.tif"
file_era5_tn7am <- "era5_daily_reanalysis_20220601_20220831_TN7am.tif"
file_era5_tn12am <- "era5_daily_reanalysis_20220601_20220831_TN12am.tif"

era5_tnwmo <- rast(paste0(input_path, file_era5_tnwmo))
era5_tn7am <- rast(paste0(input_path, file_era5_tn7am))
era5_tn12am <- rast(paste0(input_path, file_era5_tn12am))

era5_tnwmo <- project(era5_tnwmo, "EPSG:4326")
era5_tn7am <- project(era5_tn7am, "EPSG:4326")
era5_tn12am <- project(era5_tn12am, "EPSG:4326")

aws_timecov_tnwmo <- terra::extract(era5_tnwmo, aws_timecov, bind = TRUE)
aws_timecov_tn7am <- terra::extract(era5_tn7am, aws_timecov, bind = TRUE)
aws_timecov_tn12am <- terra::extract(era5_tn12am, aws_timecov, bind = TRUE)

file_era5_txwmo <- "era5_daily_reanalysis_20220601_20220831_TXwmo.tif"
file_era5_tx7am <- "era5_daily_reanalysis_20220601_20220831_TX7am.tif"
file_era5_tx12am <- "era5_daily_reanalysis_20220601_20220831_TX12am.tif"

era5_txwmo <- rast(paste0(input_path, file_era5_txwmo))
era5_tx7am <- rast(paste0(input_path, file_era5_tx7am))
era5_tx12am <- rast(paste0(input_path, file_era5_tx12am))

era5_txwmo <- project(era5_txwmo, "EPSG:4326")
era5_tx7am <- project(era5_tx7am, "EPSG:4326")
era5_tx12am <- project(era5_tx12am, "EPSG:4326")

aws_timecov_txwmo <- terra::extract(era5_txwmo,
                                    aws_timecov,
                                    bind = TRUE)
aws_timecov_tx7am <- terra::extract(era5_tx7am,
                                    aws_timecov,
                                    bind = TRUE)
aws_timecov_tx12am <- terra::extract(era5_tx12am,
                                     aws_timecov,
                                     bind = TRUE)

df_aws_timecov_tnwmo <- melt(setDT(as.data.frame(aws_timecov_tnwmo)),
                             id.vars = "STATION",
                             variable.name = "DATE",
                             value.name = "tnwmo")
df_aws_timecov_tn7am <- melt(setDT(as.data.frame(aws_timecov_tn7am)),
                             id.vars = "STATION",
                             variable.name = "DATE",
                             value.name = "tn7am")
df_aws_timecov_tn12am <- melt(setDT(as.data.frame(aws_timecov_tn12am)),
                              id.vars = "STATION",
                              variable.name = "DATE",
                              value.name = "tn12am")
df_aws_timecov_txwmo <- melt(setDT(as.data.frame(aws_timecov_txwmo)),
                             id.vars = "STATION",
                             variable.name = "DATE",
                             value.name = "TXwmo")
df_aws_timecov_tx7am <- melt(setDT(as.data.frame(aws_timecov_tx7am)),
                             id.vars = "STATION",
                             variable.name = "DATE",
                             value.name = "TX7am")
df_aws_timecov_tx12am <- melt(setDT(as.data.frame(aws_timecov_tx12am)),
                              id.vars = "STATION",
                              variable.name = "DATE",
                              value.name = "TX12am")

df <- merge(df_aws_timecov_tnwmo,
            df_aws_timecov_tn7am,
            by = c("STATION", "DATE"))
df <- merge(df, df_aws_timecov_tn12am, by = c("STATION", "DATE"))
df <- merge(df, df_aws_timecov_txwmo, by = c("STATION", "DATE"))
df <- merge(df, df_aws_timecov_tx7am, by = c("STATION", "DATE"))
df <- merge(df, df_aws_timecov_tx12am, by = c("STATION", "DATE"))
```

Merge all extracted covariates to aws dataframe

```{r}
df$DATE <- as.Date(as.numeric(df$DATE), origin = "2022-06-01")
aws$DATE <- as.Date(aws$DATE)
aws <- merge(df, aws, by = c("STATION", "DATE"))

aws <- merge(aws, aws_spatcov, by = c("STATION"))
colnames(aws)[which(names(aws) == "NC_imperviousness_2019")] <- "imp"
colnames(aws)[which(names(aws) == "NC_tree-canopy-cover_2021")] <- "tcc"
colnames(aws)[which(names(aws) == "NorthCarolina_sum")] <- "build_fp"
colnames(aws)[which(names(aws) == "Layer_1")] <- "dem"

# -- change Fahrenheit to Celsius for TMIN and TMAX
# -- caution: initial temperature is rounded to Fahrenheit so
# conversion to degree
# -- leads to ~.56 degree celcius precision
aws$TMIN <- round((aws$TMIN - 32) * 5 / 9, 2)
aws$TMAX <- round((aws$TMAX - 32) * 5 / 9, 2)

datatable(aws[, c("STATION", "TMIN", "TNwmo", "TMAX", "TXwmo",
                  "nb_na_tn", "dem", "imp", "tcc", "build_fp", "build_h")],
          filter = "top")
```

#### Save NOAA dataset with covariates

```{r}
file <- "NC-AWS-NOAA-dailysummary-20220601-20220831-space-time-covariates.csv"
fwrite(aws, paste0(input_path, file))
```

## Investigation on differences between NOAA obs and ERA5 reanalysis

#### T_obs-T_era5 computation

```{r}
aws$dTN <- aws$TMIN - aws$tn
aws$dTX <- aws$TMAX - aws$TX
hist(aws$dtn, breaks = seq(-15, 15, .5))
hist(aws$dTX, breaks = seq(-15, 15, .5))
```

#### Data source extraction

7 = COOP = U.S. Cooperative Summary of the Day \-- Transmitted via WxCoder3
(NCDC DSI-3207)

R = USCRN =NCDC Reference Network Database (Climate Reference Network and 
Historical Climatology Network-Modernized) 
<https://www.ncei.noaa.gov/access/crn/>

U = RAWS = Remote Automatic Weather Station (RAWS) data obtained from the 
Western Regional Climate Center <https://wrcc.dri.edu>

W = WBAN = WBAN/ASOS Summary of the Day from NCDC's Integrated 
Surface Data (ISD).

```{r}
library(stringr)
# -- add source feature
aws$source <- lapply(aws[, c("TMIN_ATTRIBUTES")],
                     FUN = function(x) str_sub(x, -1, -1))
```

Map of difference between obs and reanalysis

```{r}
aws_plot <- aws
aws_plot$dtn <- aws_plot$TMIN - aws_plot$tn
aws_plot$dTX <- aws_plot$TMAX - aws_plot$TX
aws_plot <- aws_plot[, .(dtn = median(dtn), dTX = median(dTX)),
                     keyby = c("STATION", "LONGITUDE", "LATITUDE", "source")]

aws_plot <- vect(aws_plot, geom = c("LONGITUDE", "LATITUDE"),
                 crs = "EPSG:4326", keepgeom = TRUE)

nc_poly <- paste0("NC_county_boundary/",
                  "North_Carolina_State_and_County_Boundary_Polygons.shp")
nc_borders <- vect(paste0(input_path, nc_poly))

aws_plot <- project(aws_plot, crs(nc_borders))

ggplot() +
  geom_spatvector(
    data = aws_plot,
    aes(fill = dtn, shape = source),
    color = "black", size = 2
  ) +
  geom_sf(
    data = st_as_sf(nc_borders), aes(geometry = geometry),
    colour = "black", linewidth = .3, fill = NA
  ) +
  scale_fill_stepsn(colours = c("navyblue", "white", "red"),
                    breaks = seq(-7, 7, 1), limits = c(-7, 7)) +
  scale_shape_manual(values = c(21, 22, 23, 24),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  labs(
    fill = "",
    title = "median(tn(obs)-tn(era5))",
    subtitle = ""
  ) +
  annotation_scale(
    location = "bl", pad_x = unit(1, "cm"),
    pad_y = unit(1, "cm"),
    height = unit(0.30, "cm"),
    text_cex = 1
  ) +
  annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "cm"),
    pad_y = unit(0.2, "cm")
  ) +
  theme(
    axis.text = element_text(size = 12, family = "serif"),
    plot.caption = element_text(size = 10, family = "serif"),
    legend.text = element_text(size = 12, family = "serif"),
    legend.title = element_text(size = 12, family = "serif"),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(colour = "grey")
  )
ggsave("../output/era5_observations_gap_map_TN.png",
       width = 7, height = 4, dpi = 300)

ggplot() +
  geom_spatvector(
    data = aws_plot,
    aes(fill = dTX, shape = source),
    color = "black", size = 2
  ) +
  geom_sf(
    data = st_as_sf(nc_borders), aes(geometry = geometry),
    colour = "black", linewidth = .3, fill = NA
  ) +
  scale_fill_stepsn(colours = c("navyblue", "white", "red"),
                    breaks = seq(-7, 7, 1), limits = c(-7, 7)) +
  scale_shape_manual(values = c(21, 22, 23, 24),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  labs(
    fill = "",
    title = "median(TX(obs)-TX(era5))",
    subtitle = ""
  ) +
  annotation_scale(
    location = "bl", pad_x = unit(1, "cm"),
    pad_y = unit(1, "cm"),
    height = unit(0.30, "cm"),
    text_cex = 1
  ) +
  annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "cm"),
    pad_y = unit(0.2, "cm")
  ) +
  theme(
    axis.text = element_text(size = 12, family = "serif"),
    plot.caption = element_text(size = 10, family = "serif"),
    legend.text = element_text(size = 12, family = "serif"),
    legend.title = element_text(size = 12, family = "serif"),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(colour = "grey")
  )
ggsave("../output/era5_observations_gap_map_TX.png",
       width = 7, height = 4, dpi = 300)

aws_plot %>%
  count(source) %>%
  as.data.frame()
```

Same plot with reliable datasources only

```{r}
ggplot() +
  geom_spatvector(
    data = aws_plot[which(!(aws_plot$source %in% c("7", "U"))), ],
    aes(fill = dtn, shape = source),
    color = "black", size = 2
  ) +
  geom_sf(
    data = st_as_sf(nc_borders), aes(geometry = geometry),
    colour = "black", linewidth = .3, fill = NA
  ) +
  scale_fill_stepsn(colours = c("navyblue", "white", "red"),
                    breaks = seq(-7, 7, 1), limits = c(-7, 7)) +
  scale_shape_manual(values = c(21, 22, 23, 24),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  labs(
    fill = "",
    title = "median(tn(obs)-tn(era5))",
    subtitle = ""
  ) +
  annotation_scale(
    location = "bl", pad_x = unit(1, "cm"),
    pad_y = unit(1, "cm"),
    height = unit(0.30, "cm"),
    text_cex = 1
  ) +
  annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "cm"),
    pad_y = unit(0.2, "cm")
  ) +
  theme(
    axis.text = element_text(size = 12, family = "serif"),
    plot.caption = element_text(size = 10, family = "serif"),
    legend.text = element_text(size = 12, family = "serif"),
    legend.title = element_text(size = 12, family = "serif"),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(colour = "grey")
  )
ggsave("../output/era5_observations_gap_map_TN_reliable_aws.png",
       width = 7, height = 4, dpi = 300)


ggplot() +
  geom_spatvector(
    data = aws_plot[which(!(aws_plot$source %in% c("7", "U"))), ],
    aes(fill = dTX, shape = source),
    color = "black", size = 2
  ) +
  geom_sf(
    data = st_as_sf(nc_borders), aes(geometry = geometry),
    colour = "black", linewidth = .3, fill = NA
  ) +
  scale_fill_stepsn(colours = c("navyblue", "white", "red"),
                    breaks = seq(-7, 7, 1), limits = c(-7, 7)) +
  scale_shape_manual(values = c(21, 22, 23, 24),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  labs(
    fill = "",
    title = "median(TX(obs)-TX(era5))",
    subtitle = ""
  ) +
  annotation_scale(
    location = "bl", pad_x = unit(1, "cm"),
    pad_y = unit(1, "cm"),
    height = unit(0.30, "cm"),
    text_cex = 1
  ) +
  annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "cm"),
    pad_y = unit(0.2, "cm")
  ) +
  theme(
    axis.text = element_text(size = 12, family = "serif"),
    plot.caption = element_text(size = 10, family = "serif"),
    legend.text = element_text(size = 12, family = "serif"),
    legend.title = element_text(size = 12, family = "serif"),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(colour = "grey")
  )
ggsave("../output/era5_observations_gap_map_TX_reliable_aws.png",
       width = 7, height = 4, dpi = 300)
```

Boxplot per station

```{r}
ptn <- ggplot(aws) +
  geom_boxplot(aes(y = dtn, x = STATION, group = STATION, color = source)) +
  scale_color_manual(values = c("lightcoral", "cyan3", "purple", "olivedrab3"),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  geom_hline(aes(yintercept = 0), color = "red") +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = -1), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = 5), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = -5), linetype = 2, color = "blue") +
  theme(axis.text.x = element_blank())

ptx <- ggplot(aws) +
  geom_boxplot(aes(y = dTX, x = STATION, group = STATION, color = source)) +
  scale_color_manual(values = c("lightcoral", "cyan3", "purple", "olivedrab3"),
                     labels = c("7" = "COOP", "R" = "CRNHCN", "U" = "RAWS",
                                "W" = "ISD")) +
  geom_hline(aes(yintercept = 0), color = "red") +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = -1), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = 5), linetype = 2, color = "blue") +
  geom_hline(aes(yintercept = -5), linetype = 2, color = "blue") +
  theme(axis.text.x = element_blank())

library(ggpubr)
ggarrange(ptn, ptx, nrow = 2)
ggsave("../output/error_boxplot_per_stations.png",
       width = 15, height = 7, dpi = 300)
```

Regression plots

```{r}
ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[1:40])]) +
  geom_point(aes(x = TMIN, y = tn), alpha = .5) +
  facet_wrap(~STATION) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[41:80])]) +
  geom_point(aes(x = TMIN, y = tn), alpha = .5) +
  facet_wrap(~STATION) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[81:120])]) +
  geom_point(aes(x = TMIN, y = tn), alpha = .5) +
  facet_wrap(~STATION) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)

ggplot(aws[which(aws$STATION %in% unique(aws$STATION)[121:166])]) +
  geom_point(aes(x = TMIN, y = tn), alpha = .5) +
  facet_wrap(~STATION) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)

ggplot(aws) +
  geom_point(aes(x = TMIN, y = tn), alpha = .1) +
  facet_wrap(~source) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)
ggsave("../output/scatterplot_era5_vs_obs_TN.png",
       width = 5, height = 5, dpi = 300)

ggplot(aws) +
  geom_point(aes(x = TMAX, y = TX), alpha = .1) +
  facet_wrap(~source) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -1, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = 5, slope = 1, color = "blue", linetype = "dashed",
              size = .5) +
  geom_abline(intercept = -5, slope = 1, color = "blue", linetype = "dashed",
              size = .5)
ggsave("../output/scatterplot_era5_vs_obs_TX.png",
       width = 5, height = 5, dpi = 300)
```

## Technical details for observations labels

**TMAX** -- Monthly Maximum Temperature. Average of daily maximum temperature 
given in Fahrenheit on PDF output. CSV output is given in Fahrenheit (default) 
or Celsius depending on user specification. Missing if more than 5 days within 
the month are missing or flagged or if more than 3 consecutive values within 
the month are missing or flagged.

**TMAX_ATTRIBUTES =** M,Q,S where:
M = GHCN-Daily Dataset Measurement Flag (values are given below in Table C)
Q = GHCN-Daily Dataset Quality Flag (values are given below in Table D)
S = GHCN-Daily Dataset Source Code (values are given below in Table B)

**TMIN** -- Monthly Minimum Temperature. Average of daily minimum temperature
given in Fahrenheit units on PDF output. CSV output is given in Fahrenheit 
(default) or Celsius units depending on user specification. Missing if more 
than 5 days within the month are missing or flagged or if more than 3 
consecutive values within the month are missing or flagged.

**TMIN_ATTRIBUTES =** M,Q,S where:
M = GHCN-Daily Dataset Measurement Flag (values are given below in Table C)
Q = GHCN-Daily Dataset Quality Flag (values are given below in Table D)
S = GHCN-Daily Dataset Source Code (values are given below in Table B)

**Table C - GHCN-Daily Dataset Measurement Flag**

Blank = no measurement information applicable
H = represents highest or lowest hourly temperature (TMAX or TMIN) or the 
average of hourly values (TAVG)

**Table D - GHCN-Daily Dataset Quality Flags (as of 1/9/2017):**

Blank = did not fail any quality assurance check
S = failed spatial consistency check

**Table B - GHCN-Daily Dataset Source Codes:**

7 = U.S. Cooperative Summary of the Day \-- Transmitted via WxCoder3
(NCDC DSI-3207)
R = NCDC Reference Network Database (Climate Reference Network and Historical Climatology Network-Modernized) <https://www.ncei.noaa.gov/access/crn/>
U = Remote Automatic Weather Station (RAWS) data obtained from the Western 
Regional Climate Center <https://wrcc.dri.edu>
W = WBAN/ASOS Summary of the Day from NCDC's Integrated Surface Data (ISD).
