---
title: "create-prediction-grid"
output:
  pdf_document: default
  html_document: default
date: "2023-07-20"
---

Libraries

```{r, message=F}
#library(raster)   # -- old
#library(sp)       # -- old
#library(rgdal)    # -- deprecated in 10/2023
#library(rgeos)    # -- deprecated in 10/2023
#library(maptools) # -- deprecated in 10/2023
library(terra)
library(sf)

library(ggplot2)
library(ggspatial)
library(tidyterra)
library(rgeos)
```

### In this script...

#### 1) Create empty grid

1.  Open NC borders and 30m-imperviousness data over NC

2.  Compute imperviousness mean over 5km-resolution grid

3.  Create an urban mask defined as 5kmx5km grid cells with imperviousness \>5%

4.  Create a grid with 1kmx1km cells above rural areas and 200mx200m cells above urban ones

#### 2) Add covariates

-   Land cover and urban indicators: imperviousness, building footprint, building height, tree canopy cover

-   Digital Elevation Model (DEM)

-   Meteorological covariates (pb evolves in time)

## Empty grid creation

### NC borders

```{r}
nc.borders <- vect("../input/NC_county_boundary/North_Carolina_State_and_County_Boundary_Polygons.shp")
```

Change nc.borders units (us feet to meter)

```{r}
crs.meters <- "+proj=lcc +lat_0=33.75 +lon_0=-79 +lat_1=36.1666666666667 +lat_2=34.3333333333333 +x_0=609601.219202439 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
nc.borders <- project(nc.borders, crs.meters)
```

### 5km-resolution imperviousness grid

Open and map imperviousness 30m-resolution data across NC

```{r}
imp <- rast("../input/NC_imperviousness_2019.tif")
imp <- project(imp, crs.meters)

imp.plot <- ifel(imp==0, NA, imp)
ggplot() +
  geom_spatraster(data = imp.plot) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  scale_fill_whitebox_c(
    palette = "muted",
    labels = scales::label_number(suffix = "%"),
    n.breaks = 12,
    guide = guide_legend(reverse = TRUE),
    na.value=NA
  ) +
  labs(
    fill = "",
    title = "Prediction grid"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
```

Create 5km and 10km-resolution raster in NC shapefile

```{r}
grid.10km <- rast(ext(nc.borders), resolution = c(10000, 10000), crs = crs.meters)
grid.10km <- extend(grid.10km, c(1,1))
grid.10km <- as.polygons(grid.10km)
grid.10km <- terra::intersect(grid.10km, nc.borders)
plot(grid.10km)

grid.5km <- rast(ext(nc.borders), resolution = c(5000,5000), crs = crs.meters)
grid.5km <- extend(grid.5km, c(1,1))
grid.5km <- as.polygons(grid.5km)
grid.5km <- terra::intersect(grid.5km, nc.borders)
plot(grid.5km)
```

Compute and save 5kmx5km imperviousness file (each 5kmx5km cell is the mean of 30mx30m info)

```{r, eval=F}
imp.mean <- zonal(imp, final.grid, fun='mean', as.raster=T)
writeRaster(imp.mean, filename="../input/NC_imperviousness_2019_5kmx5km.tif", overwrite=T)
```

Open and map the 5kmx5km imperviousness file

```{r}
imp.mean <- rast("../input/NC_imperviousness_2019_5kmx5km.tif")
ggplot() +
  geom_spatraster(data = imp.mean) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "white", linewidth=.3, fill = NA) +
  scale_fill_whitebox_c(
    palette = "muted",
    labels = scales::label_number(suffix = "%"),
    n.breaks = 12,
    guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "North Carolina imperviousness rate"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
```

### Create urban and rural masks

-   Urban pixels: 5kmx5km imperviousness \> 5%

-   Urban pixels: 5kmx5km imperviousness \<= 5%

```{r}
urb.mask <- ifel(imp.mean>5, 1, NA)
rur.mask <- ifel(imp.mean<=5, 1,NA)
ggplot() +
  geom_spatraster(data = urb.mask) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  scale_fill_whitebox_c(
    palette = "deep",
    labels = scales::label_number(suffix = ""),
    na.value=NA
  ) +
  labs(
    fill = "",
    title = "North Carolina urban mask"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.position = "none",
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
```

Urban grid (200m-resolution)

```{r}
urb.pol <- as.polygons(urb.mask)
urb.rast <- rast(urb.pol, resolution = c(200, 200), crs = crs.meters)
urb.grid <- as.polygons(urb.rast)
urb.grid <- terra::intersect(urb.grid, urb.pol)
```

Rural grid (1km-resolution)

```{r}
rur.pol <- as.polygons(rur.mask)
rur.rast <- rast(rur.pol, resolution = c(1000, 1000), crs = crs.meters)
rur.grid <- as.polygons(rur.rast)
rur.grid <- terra::intersect(rur.grid, rur.pol)
```

### Map and save empty prediction grid

```{r}
m <- ggplot() +
  geom_spatvector(data = urb.grid, color='orange', size=.1) +
  geom_spatvector(data = rur.grid, color='green', size=.1) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  labs(
    fill = "",
    title = "Prediction grid"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
m
```

Save urban and rural grid (squared polygons) and save all prediction grid as a unique dataframe (centroids of raster's polygons, coordinates in wgs84)

```{r}
urb.grid.df <- centroids(urb.grid, inside=T)
#urb.grid.df <- project(urb.grid.df, "+proj=longlat +datum=WGS84")
#urb.grid.df <- as.data.frame(geom(urb.grid.df, xnm='lon', ynm='lat'))
#urb.grid.df <- urb.grid.df[, c('x','y')]
#colnames(urb.grid.df) <- c('lon', 'lat')
#head(urb.grid.df)

rur.grid.df <- centroids(rur.grid, inside=T)
#rur.grid.df <- project(rur.grid.df, "+proj=longlat +datum=WGS84")
#rur.grid.df <- as.data.frame(geom(rur.grid.df, xnm='lon', ynm='lat'))
#rur.grid.df <- rur.grid.df[, c('x','y')]
#colnames(rur.grid.df) <- c('lon', 'lat')

#grid.df <- rbind(urb.grid.df, rur.grid.df)
#writeVector(grid.df, filename="../inout/empty_prediction_grid.shp", overwrite=T)
grid.points <- rbind(urb.grid.df, rur.grid.df)
```

## Covariates addition

Interesting: with the terra::extract function, possibility to chose method='bilinear' to return a value interpolated from the values of the four nearest raster cells.

```{r}
grid.points <- project(grid.points, crs.meters)
```

Create entent for RTP area if we want to plot a zoom

```{r}
lat <- c(35.6, 36.11, 36.11, 35.6)
lon <- c(-79.19, -79.10, -78.39, -78.39)
#rtp.ext <- ext(35.61, 36.10, -79.21, -78.38)
ext.rtp <- vect(cbind(lon, lat), type="points", crs="+proj=longlat +datum=WGS84")
ext.rtp <- project(ext.rtp, crs(build.fp))
ext(ext.rtp)
```

### Imperviousness

```{r}
imp.extract <- terra::extract(imp, grid.points, ID=T) 
```

### Tree canopy cover

```{r}
tcc <-  rast("../input/NC_tree-canopy-cover_2021.tif")
tcc <- project(tcc, crs.meters)
tcc.extract <- terra::extract(tcc, grid.points, fun='mean', method='bilinear') 
tcc.extract.raw <- terra::extract(tcc, grid.points) 

tcc.plot <- ifel(tcc!=0, tcc, NA)
ggplot() +
  geom_spatraster(data = tcc.plot) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "white", linewidth=.3, fill = NA) +
  scale_fill_whitebox_c(
    palette = "gn_yl",
    direction=-1,
    labels = scales::label_number(suffix = "%"),
    n.breaks = 12,
    limits=c(0,100),
    guide = guide_legend(reverse = T),
    na.value=NA
  ) +
  labs(
    fill = "",
    title = "Tree canopy cover"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
```

### Building footprint

```{r}
build.fp <-  rast("../input/NC_building-footprints/NorthCarolina_sum.tif")
build.fp <- project(build.fp, crs.meters)

build.fp.plot <- ifel(build.fp!=0, build.fp, NA)
build.fp.rtp <- crop(build.fp.plot, ext.rtp)

ggplot() +
  geom_spatraster(data = build.fp.rtp) +
  scale_fill_whitebox_c(
    palette = "muted",
    labels = scales::label_number(suffix = ""),
    n.breaks = 12,
    guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "Building footprint (m^2)"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)

build.fp.extract <- terra::extract(build.fp, grid.points, fun='mean', method='bilinear') 
```

### Building height

```{r}
build.h <-  vect("../input/NC_building-height-by-block/NC_building-heights-by-block.shp")
build.h <- project(build.h, crs.meters)

ggplot() +
  geom_spatvector(data = build.h, aes(fill=Height_cat), color=NA) +
  geom_sf(data = st_as_sf(nc.borders), aes(geometry=geometry), 
               colour = "white", linewidth=.3, fill = NA) +
  scale_fill_manual(
    breaks = c("Low", "Low-medium", "Medium", "Medium-High", "High", "Very high"),
    values = c("#38a700" ,"#d0ff73","#feebbf","#ff7f7e","#e60100", "#720000")
  ) +
  labs(
    fill = "",
    title = "Building height by block"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot.caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
build.h.extract <- terra::extract(build.h, grid.points) 
head(build.h.extract)
```

### Digital Elevation Model

```{r}
dem <- rast("../input/NC-DEM.tif")
plot(dem)
dem.extract <- terra::extract(dem, grid.points, ID=T) 
head(dem.extract)
```

### Meteorological covariates

```{r}

```

#### Session info

```{r}
sessionInfo()
```
