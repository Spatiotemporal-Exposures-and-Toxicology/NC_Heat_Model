---
title: "Add covariates: example on RTP area"
output: html_document
date: "2023-11-09"
---

Load tools

```{r, message=F}
pkgs <- c(
  "tidyverse",
  "terra",
  "sf",
  "sftime",
  "reshape2",
  "stringr",
  "dplyr",
  "exactextractr",
  "tidyterra",
  "viridis",
  "ggplot2"
)
sapply(pkgs, library, character.only = TRUE)
source("../R/add_covariates.R")
source("../R/manipulate_spacetime_data.R")
```


```{r}
nc <- vect(paste0(
  "../input/NC_county_boundary/",
  "North_Carolina_State_and_County_Boundary_Polygons.shp"
))
same.crs(crs(nc), "EPSG:6543")
```

# Create prediction grid based on imperviousness aggregation

```{r}
imp <- rast("../input/NC_imperviousness_2019.tif")
nc_proj <- terra::project(nc, crs(imp))
imp <- terra::mask(imp, nc_proj)
# aggregation at 300m
pred_rast <- aggregate(imp, fact = 10, fun = "mean")
names(pred_rast) <- "imp"
plot(pred_rast)
```
# Covariate extraction on RTP area

### Zoom on RTP area

```{r}
lat <- c(35.6, 36.11, 36.11, 35.6)
lon <- c(-79.19, -79.19, -78.39, -78.39)
ext_rtp <- vect(cbind(lon, lat), type = "polygons", crs = "EPSG:4326")
ext_rtp <- terra::project(ext_rtp, crs(pred_rast))
pred_rast_rtp <- terra::crop(pred_rast, ext_rtp)
pred_vect_rtp <- terra::as.points(pred_rast_rtp)
```


### Add spatial covariates

Tree canopy height

```{r}
pred_vect_rtp <- add_canopy_h(sp_vect = pred_vect_rtp)
```

Digital elevation model 

```{r}
pred_vect_rtp <- add_dem(sp_vect = pred_vect_rtp)
```

Tree canopy cover 

```{r}
pred_vect_rtp <- add_tcc(sp_vect = pred_vect_rtp)
```

Building footprint

```{r}
pred_vect_rtp <- add_build_fp(sp_vect = pred_vect_rtp)
```

Building height

```{r}
pred_vect_rtp <- add_build_h(sp_vect = pred_vect_rtp)
```

Land cover ratio
 
```{r}
lc <- rast("../input/NC_nlcd_crs-wgs84.tif")
pred_vect_rtp <- add_nlcd_class_ratio(pred_vect_rtp, nlcd = lc)
```


```{r}
pred_rast_rtp <- terra::rasterize(pred_vect_rtp,
  pred_rast_rtp,
  field = names(pred_vect_rtp)
)
head(pred_rast_rtp)
plot(pred_rast_rtp[[1:6]])
plot(pred_rast_rtp[[7:21]])
```

Add terrain covariates to raster

```{r}
pred_rast_rtp <- add_terrain(pred_rast_rtp)
plot(pred_rast_rtp[[22:25]])
```

### Create a SpatRasterDataset with all spatial covariates 

```{r}
pred_rastds <- list()
for (i in names(pred_rast_rtp)) {
  pred_rastds[[i]] <- pred_rast_rtp[[i]]
}
pred_rastds <- terra::sds(pred_rastds)
```

### Add temporal covariates

```{r}
era5 <- fread("../input/era5_daily_reanalysis_2022-05-02_2022-09-29.csv")
era5 <- era5 %>% rename(time = date)

# convert to stdt and then to SpatRasterDataset
era5_stdt <- create_stdtobj(era5, "EPSG:4326")
era5_rastds <- convert_stdt_spatrastdataset(era5_stdt)
plot(era5_rastds$TNwmo$`2022-05-02`)

# empty prediction SpatVector
new_pred_vect_rtp <- vect(geom(pred_vect_rtp)[, c("x", "y")],
  type = "points",
  crs = crs(pred_vect_rtp)
)
pred_rds_era5 <- list()
for (i in 2:7) {
  pred_rds_era5[[i - 1]] <- terra::project(
    new_pred_vect_rtp,
    crs(era5_rastds[[i]])
  ) %>%
    terra::extract(x = era5_rastds[[i]], y = ., bind = TRUE) %>%
    terra::project(., crs(new_pred_vect_rtp)) %>%
    terra::rasterize(., pred_rast_rtp, field = names(.))
}
pred_rds_era5 <- terra::sds(pred_rds_era5)
names(pred_rds_era5) <- names(era5_rastds[[2:7]])
plot(pred_rds_era5$TNwmo$`2022-05-07`)
```
### TODEL

```{r}
# empty prediction SpatVector
new_pred_vect_rtp <- vect(geom(pred_vect_rtp)[, c("x", "y")],
  type = "points",
  crs = crs(pred_vect_rtp)
)
pred_rds_era5 <- list()
for (i in 2:7) {
  pred_rds_era5[[i - 1]] <- terra::project(
    new_pred_vect_rtp,
    crs(era5_rastds[[i]])
  ) %>%
    terra::extract(x = era5_rastds[[i]], y = ., bind = TRUE) %>%
    terra::project(., crs(new_pred_vect_rtp)) %>%
    as.data.frame(., geom = "XY") %>%
    reshape2::melt(.,
      id.vars = c("x", "y"),
      variable.name = "time",
      value.name = names(era5_rastds)[[i]]
    )
}

df <- pred_vect_rtp %>%
  as.data.frame(., geom = "XY")


# PROBLEME : les coordonnees ne semblent plus correspondre, peut etre a cause
# des reprojections successives
output_vect <- pred_rds_era5 %>%
  reduce(inner_join, by = c("x", "y", "time")) %>%
  reduce(.x = list(., df), .f = inner_join, by = c("x", "y")) %>%
  rename("lon" = "x") %>%
  rename("lat" = "y") %>%
  vect(.,
    geom = c("lon", "lat"),
    crs = crs(new_pred_vect_rtp),
    keepgeom = TRUE
  )


v <- df[which(unique(hello[, c("x", "y")]) == unique(df[, c("x", "y")])), ]
nrow(v)
plot(v$x, v$y, cex = 0.01)
```


### Merge both SpatRasterDatasets to have all the covariates in the same one

```{r}
pred_rastds <- c(pred_rds_era5, pred_rastds)
plot(pred_rastds$imp)
plot(pred_rastds$frac_42)
plot(pred_rastds$TNwmo$`2022-05-27`)
plot(pred_rastds$TNwmo$`2022-08-27`)
```

# Covarites on entire North Carolina

Output of create_prediction_grid_full.R (launched on geo HPC on Nov 22nd 2023)

```{r}
eg1 <- terra::rast("../input/pred_grid_2022-05-18.tif")
eg2 <- terra::rast("../input/pred_grid_2022-08-18.tif")
```

Land cover index

```{r}
nlcd_classes <- list(
  value = c(
    11, 21, 22, 23, 24, 31, 41, 42, 43, 52,
    71, 81, 82, 90, 95
  ),
  class = c(
    "WTR", "OSD", "LID", "MID", "HID",
    "BRN", "DFO", "EFO", "MFO", "SHB",
    "GRS", "PAS", "CRP", "WDW", "EHW"
  ),
  names = c(
    "Open Water",
    "Developed, Open Space",
    "Developed, Low Intensity",
    "Developed, Medium Intensity",
    "Developed, High Intensity",
    "Barren Land",
    "Deciduous Forest",
    "Evergreen Forest",
    "Mixed Forest",
    "Shrub/Scrub",
    "Herbaceous",
    "Hay/Pasture",
    "Cultivated Crops",
    "Woody Wetlands",
    "Emergent Herbaceous Wetlands"
  ),
  col = c(
    "#476ba1", "#decaca", "#d99482", "#ee0000",
    "#ab0000", "#b3aea3", "#68ab63", "#1c6330",
    "#b5ca8f", "#ccba7d", "#e3e3c2", "#dcd93d",
    "#ab7028", "#bad9eb", "#70a3ba"
  )
)
nlcd_classes <- as.data.frame(nlcd_classes)
```

```{r}
terra::plot(eg1[[c(1:6, 22:25)]])
terra::plot(eg1[[7:21]])
nlcd_classes
terra::plot(eg1[[26:31]])
terra::plot(eg2[[26:31]])
```
