---
title: "open-project-spatial-covariates.R"
output: html_document
date: "2023-08-22"
---

Libraries

```{r, message=F}
library(terra)
library(sf)
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(rgeos)
library(data.table) # -- for large flat datasets
```

```{r}
input_path <- "../input/"
```

Open data

```{r}
imp_file <- "NC_imperviousness_2019_crs-meters.tif"
tcc_file <- "NC_tree-canopy-cover_2021_crs-meters.tif"
build_fp_file <- paste0("input/NC_building-footprints/",
                        "NorthCarolina_sum_crs-meters.tif")
build_h_file <- paste0("NC_building-height-by-block/",
                       "NC_building-heights-by-block_crs-meters.shp")
dem_file <- "NC-DEM_crs-meters.tif"

imp <- rast(paste0(input_path, imp_file))
tcc <- rast(paste0(input_path, tcc_file))
build_fp <- rast(paste0(input_path, build_fp_file))
build_h <- vect(paste0(input_path, build_h_file))
dem <- rast(paste0(input_path, dem_file))
```

```{r}
crs(imp)
cat("\n")
crs(tcc)
cat("\n")
crs(build_fp)
cat("\n")
crs(build_h)
cat("\n")
crs(dem)
```

Choose a projection

```{r}
crs <- "EPSG:4326"
crs_name <- "crs-wgs84"
cat(crs)
```

Project data and save the data

```{r}
# -- imperviousness
imp_p <- project(imp, crs)
writeRaster(imp_p,
            filename = paste0(input_path,
                              "NC_imperviousness_2019_",
                              crs_name,
                              ".tif"),
            overwrite = TRUE)

# -- tree canopy cover
tcc_p <- project(tcc, crs)
writeRaster(tcc_p,
            filename = paste0(input_path,
                              "NC_tree-canopy-cover_2021_",
                              crs_name,
                              ".tif"),
            overwrite = TRUE)

# -- building footprint
build_fp_p <- project(build_fp, crs)
writeRaster(build_fp_p,
            filename = paste0(input_path,
                              "NC_building-footprints/NorthCarolina_sum_",
                              crs_name,
                              ".tif"),
            overwrite = TRUE)

# -- building height
build_h_p <- project(build_h, crs)
writeVector(build_h_p,
            filename = paste0(input_path,
                              "NC_building-height-by-block/",
                              "NC_building-heights-by-block_",
                              crs_name,
                              ".shp"),
            overwrite = TRUE)

# -- digital elevation model
dem_p <- project(dem, crs)
writeRaster(dem_p,
            filename = paste0(input_path,
                              "NC-DEM_",
                              crs_name,
                              ".tif"),
            overwrite = TRUE)
```

Important: it sounds like there are missing tiles in building footprint data. 
An explanation can be found in the paper Heris, M.P., Foks, N., Bagstad, K., 
and Troy, A., 2020, A national dataset of rasterized building footprints for 
the U.S.: U.S. Geological Survey data release, 
<https://doi.org/10.5066/P9J2Y1WG.>:

"*We also identified systematic gaps in the Microsoft data for some geographic 
areas. These larger gaps seem to have a tile pattern, where aerial photos may 
have been unavailable to the Microsoft building detection algorithm"*

Their computational algorithm is applied to Microsoft released a U.S.-wide 
vector building dataset provided in 2018 but this dataset has missing tiles.
