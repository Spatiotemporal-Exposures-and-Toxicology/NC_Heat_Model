---
title: "era5-reanalysis-processing"
output: github_document
 #pdf_document: default
#  html_document: default
date: "2023-07-24"
---

#### Libraries

```{r, message=FALSE}
options("sp_evolution_status" = 2) # use sf instead of rgdal and rgeos in sp
library(sp)
library(terra)
library(sf)
library(ncdf4)

# -- for timeseries
library(lubridate)
library(zoo)
library(xts)

# --
library(ggplot2)
library(ggspatial)
library(tidyterra)
library(maditr)
library(tidyverse)
library(viridis)
library(DT)
```


```{r}
input_path <- "../input/"
```

#### NC shapefile

```{r, warning=FALSE}
nc_poly <- paste0("NC_county_boundary/",
                  "North_Carolina_State_and_County_Boundary_Polygons.shp")
nc_borders <- vect(paste0(input_path, nc_poly))
```

#### Map function creation

Create a function to map rasters with NC borders

```{r}
my_map_raster <- function(raster, date, title) {
  plot <- ggplot() +
    geom_spatraster(data = raster) +
    geom_sf(
      data = st_as_sf(nc_borders), aes(geometry = geometry),
      colour = "white", linewidth = .3, fill = NA
    ) +
    scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ยบ"),
      n.breaks = 12,
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = title,
      subtitle = date
    ) +
    annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(1, "cm"),
      height = unit(0.30, "cm"),
      text_cex = 1
    ) +
    annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.2, "cm")
    ) +
    theme(
      axis.text = element_text(size = 12, family = "serif"),
      plot.caption = element_text(size = 10, family = "serif"),
      legend.text = element_text(size = 12, family = "serif"),
      legend.title = element_text(size = 12, family = "serif"),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

  return(plot)
}


my_map_raster_points <- function(raster, points, points.fill, date, title) {
  fill <- enquo(points.fill)
  plot <- ggplot() +
    geom_spatraster(data = raster) +
    geom_sf(
      data = points,
      aes(geometry = geometry, fill = !!fill), color = "black",
      size = 2, shape = 21
    ) +
    geom_sf(
      data = st_as_sf(nc_borders), aes(geometry = geometry),
      colour = "white", linewidth = .3, fill = NA
    ) +
    scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ยบ"),
      n.breaks = 12,
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = title,
      subtitle = date
    ) +
    annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(1, "cm"),
      height = unit(0.30, "cm"),
      text_cex = 1
    ) +
    annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.2, "cm")
    ) +
    theme(
      axis.text = element_text(size = 12, family = "serif"),
      plot.caption = element_text(size = 10, family = "serif"),
      legend.text = element_text(size = 12, family = "serif"),
      legend.title = element_text(size = 12, family = "serif"),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

  return(plot)
}
```

## Daily summary computation

#### Open and map hourly temperature ERA5 reanalysis

Open netcdf data with all JJA hourly ERA5 reanalysis

```{r}
t2m_rea <- nc_open(paste0(input_path,
                          "era5_hourly_reanalysis_20220531_20220930.nc"))
print(t2m_rea)
```

Extract data in vectors and 3d-matrix

```{r}
lon <- ncvar_get(t2m_rea, "longitude")
lat <- ncvar_get(t2m_rea, "latitude")
time <- ncvar_get(t2m_rea, "time")
t2m <- ncvar_get(t2m_rea, "t2m") - 273.15
na_value <- ncatt_get(t2m_rea, "t2m", "_FillValue")$value
t2m[t2m == na_value] <- NA
cat(paste("time units:", ncatt_get(t2m_rea, "time", "units")$value))
time <- as.POSIXct(time * 3600, origin = "1900-01-01", tz = "UTC")
```

Map T2M for one hour

```{r}
# one time
ts <- as.POSIXct("2022-08-02 18:00:00 UTC", tz = "UTC")
samp <- t2m[, , which(time == ts)]
# need to add 0.25/2 to
samp_rast <- rast(t(samp),
                  extent = c(-85.125, -74.875, 33.375, 37.125),
                  crs = "EPSG:4326")

my_map_raster(raster = samp_rast, date = paste(ts, "UTC"),
              title = "T2m North Carolina")
```

Create a datatable from the netcdf

```{r}
t2m_ts <- t2m %>%
  melt() %>%
  setDT()
t2m_ts <- t2m_ts[, .(time = time[Var3], lon = Var1, lat = Var2, t2m = value)]
head(t2m_ts)
```

Add pixel id (geom variable)

```{r}
pixels <- unique(t2m_ts[, c("lon", "lat")])
pixels$geom <- index(pixels)
t2m_ts <- merge(t2m_ts, pixels, by = c("lon", "lat"))
head(t2m_ts)
```

#### Computation of daily summary

TN

```{r}
ts <- as.POSIXct("2022-05-31 01:00:00 UTC", tz = "UTC")
te <- as.POSIXct("2022-09-01 23:00:00 UTC", tz = "UTC")
t2m_ts <- t2m_ts[between(time, ts, te)]

# -- EDT = Eastern Daylight Time (consider clock-changing)
# -- EST = Eastern Standard Time
t2m_ts <- t2m_ts[,
                 ":="(time_edt = as.POSIXct(with_tz(time,
                                                    tzone = "America/New_York"),
                                            format = "%Y-%m-%d %H:%M:%s"))]

# -- compute standard date for TN with WMO definition
assign_date_tnwmo <- function(x) {
  return(ifelse(hour(x) >= 18,
                substr(x + days(1), 0, 10),
                substr(x, 0, 10)))
}
# -- compute standard date for TN with 7am to 7am (localtime) definition
assign_date_7am <- function(x_edt) {
  return(ifelse(hour(x_edt) >= 7,
                substr(x_edt, 0, 10),
                substr(x_edt - days(1), 0, 10)))
}
# -- compute standard date for TN with 12am to 12am definition
assign_date_12am <- function(x_edt) {
  return(substr(x_edt, 0, 10))
}

t2m_ts <- t2m_ts[, ":="(dateTNwmo = as.character(assign_date_tnwmo(time)),
                        date7am = as.character(date7am(time_edt)),
                        date12am = as.character(assign_date_12am(time_edt)))]

t2m_tnwmo <- t2m_ts[, .(TNwmo = min(t2m)),
                    keyby = c("geom", "dateTNwmo", "lon", "lat")]
t2m_tn7am <- t2m_ts[, .(TN7am = min(t2m)),
                    keyby = c("geom", "date7am", "lon", "lat")]
t2m_tn12am <- t2m_ts[, .(TN12am = min(t2m)),
                     keyby = c("geom", "date12am", "lon", "lat")]

# -- merge the 3 data.tables
t2m_tn <- merge(t2m_tnwmo, t2m_tn7am,
  by.x = c("geom", "dateTNwmo", "lon", "lat"),
  by.y = c("geom", "date7am", "lon", "lat")
)
t2m_tn <- merge(t2m_tn, t2m_tn12am,
  by.x = c("geom", "dateTNwmo", "lon", "lat"),
  by.y = c("geom", "date12am", "lon", "lat")
)
colnames(t2m_tn)[colnames(t2m_tn) == "dateTNwmo"] <- "date"
t2m_tn$lon <- as.numeric(t2m_tn$lon)
t2m_tn$lat <- as.numeric(t2m_tn$lat)
t2m_tn$date <- ymd(t2m_tn$date)

# -- remove 2022-05-31 and 2022-09-01 which are not computed properly
t2m_tn <- t2m_tn[!(date == ymd("2022-05-31") | date == ymd("2022-09-01"))]

summary(t2m_tn)
beepr::beep(1)
```

TX

```{r}
# -- compute standard date for TX with WMO definition
assign_date_txwmo <- function(x) {
  return(ifelse(hour(x) < 6, substr(x - days(1), 0, 10), substr(x, 0, 10)))
}

t2m_ts <- t2m_ts[, ":="(datetxwmo = as.character(assign_date_txwmo(time)),
                        date7am = as.character(assign_date_7am(time_edt)),
                        date12am = as.character(assign_date_12am(time_edt)))]

t2m_txwmo <- t2m_ts[, .(TXwmo = max(t2m)),
                    keyby = c("geom", "datetxwmo", "lon", "lat")]
t2m_tx7am <- t2m_ts[, .(TX7am = max(t2m)),
                    keyby = c("geom", "date7am", "lon", "lat")]
t2m_tx12am <- t2m_ts[, .(TX12am = max(t2m)),
                     keyby = c("geom", "date12am", "lon", "lat")]

# -- merge the 3 data.tables
t2m_tx <- merge(t2m_txwmo, t2m_tx7am,
  by.x = c("geom", "datetxwmo", "lon", "lat"),
  by.y = c("geom", "date7am", "lon", "lat")
)
t2m_tx <- merge(t2m_tx, t2m_tx12am,
  by.x = c("geom", "datetxwmo", "lon", "lat"),
  by.y = c("geom", "date12am", "lon", "lat")
)
colnames(t2m_tx)[colnames(t2m_tx) == "datetxwmo"] <- "date"
t2m_tx$lon <- as.numeric(t2m_tx$lon)
t2m_tx$lat <- as.numeric(t2m_tx$lat)
t2m_tx$date <- ymd(t2m_tx$date)

# -- remove 2022-05-31 and 2022-09-01 which are not computed properly
t2m_tx <- t2m_tx[!(date == ymd("2022-05-31") | date == ymd("2022-09-01"))]

summary(t2m_tx)
beepr::beep(1)
```

Check algorithm result on a given pixel

```{r}
ts <- as.POSIXct("2022-08-01 00:00:00 UTC", tz = "UTC")
te <- as.POSIXct("2022-08-31 00:00:00 UTC", tz = "UTC")
g <- 500
df_plot_h <- t2m_ts[between(time, ts, te) & geom == g]
df_plot_tx <- t2m_tx[between(as.POSIXct(date), ts, te) & geom == g]
df_plot_tn <- t2m_tn[between(as.POSIXct(date), ts, te) & geom == g]

ggplot(df_plot_h) +
  geom_line(aes(x = time, y = t2m)) +
  geom_point(data = df_plot_tx, aes(x = as.POSIXct(date), y = TXwmo),
             color = "red", shape = 1) +
  geom_point(data = df_plot_tx, aes(x = as.POSIXct(date), y = TX7am),
             color = "blue", shape = 4) +
  geom_point(data = df_plot_tx, aes(x = as.POSIXct(date), y = TX12am),
             color = "green", shape = 3) +
  geom_point(data = df_plot_tn, aes(x = as.POSIXct(date), y = TNwmo),
             color = "orange", shape = 1) +
  geom_point(data = df_plot_tn, aes(x = as.POSIXct(date), y = TN7am),
             color = "purple", shape = 4) +
  geom_point(data = df_plot_tn, aes(x = as.POSIXct(date), y = TN12am),
             color = "yellow", shape = 3)
```

Merge TN and TM in the same data.table and save it

```{r}
era5_t2m <- merge(t2m_tn, t2m_tx, by = c("geom", "date", "lon", "lat"))
fwrite(era5_t2m, paste0(input_path,
                        "era5_daily_reanalysis_20220601_20220831.csv"))
```

## Check coherence with NOAA observations

IMPORTANT: the following code is just a first sight because the standard day 
chosen for the computation of TN and TX varies from one NOAA source to another:
-   COOP: 7am to 7am local time
-   CRN: ?
-   RAWS: ?
-   ASOS/WBAN: 12am to 12am local time

#### Open NOAA obs

```{r}
aws_file <- "NC-AWS-NOAA-dailysummary-20220601-20220831.csv"
aws <- data.table::fread(paste0(input_path, aws_file))
length(unique(aws$STATION))
aws <- aws[which(!(is.na(aws$TMAX) | is.na(aws$TMIN))), ]
aws$DATE <- as.Date(aws$DATE, format = "%Y-%m-%d")
length(unique(aws$STATION))
```

Daily max temperatures

```{r, message=FALSE}
aws_ts_tx <- maditr::dcast(aws[, c("DATE", "STATION", "TMAX")],
                           DATE ~ STATION) %>%
  as.xts()
```

Daily min temperatures

```{r, message=FALSE}
aws_ts_tn <- maditr::dcast(aws[, c("DATE", "STATION", "TMIN")],
                           DATE ~ STATION) %>%
  as.xts()
```

Daily mean temperatures

```{r, message=FALSE}
aws_ts_tm <- maditr::dcast(aws[, c("DATE", "STATION", "TAVG")],
                           DATE ~ STATION) %>%
  as.xts()
```

Timeseries plots

***Important:** mean temperatures are missing for most of the weather stations.

```{r}
plot((aws_ts_tn - 32) * 5 / 9)
plot((aws_ts_tx - 32) * 5 / 9)
plot((aws_ts_tm - 32) * 5 / 9)

boxplot(t((aws_ts_tn - 32) * 5 / 9))
boxplot(t((aws_ts_tx - 32) * 5 / 9))
boxplot(t((aws_ts_tm - 32) * 5 / 9))
```

NOAA aws with less than 5% missing data

```{r , message=FALSE}
nb_na_tn <- lapply(aws_ts_tn, FUN = function(x) sum(is.na(x)))
nb_na_tn <- as.data.frame(do.call(rbind, nb_na_tn))
nb_na_tn <- cbind(STATION = rownames(nb_na_tn), nb_na_tn)
rownames(nb_na_tn) <- seq_len(nrow(nb_na_tn))
names(nb_na_tn)[names(nb_na_tn) == "V1"] <- "nb_na_tn"

nb_na_tx <- lapply(aws_ts_tx, FUN = function(x) sum(is.na(x)))
nb_na_tx <- as.data.frame(do.call(rbind, nb_na_tx))
nb_na_tx <- cbind(STATION = rownames(nb_na_tx), nb_na_tx)
rownames(nb_na_tx) <- seq_len(nrow(nb_na_tx))
names(nb_na_tx)[names(nb_na_tx) == "V1"] <- "nb_na_tx"

nb_na_tm <- lapply(aws_ts_tm, FUN = function(x) sum(is.na(x)))
nb_na_tm <- as.data.frame(do.call(rbind, nb_na_tm))
nb_na_tm <- cbind(STATION = rownames(nb_na_tm), nb_na_tm)
rownames(nb_na_tm) <- seq_len(nrow(nb_na_tm))
names(nb_na_tm)[names(nb_na_tm) == "V1"] <- "nb_na_tm"

stations <- unique(aws[, c("STATION", "NAME", "LATITUDE",
                           "LONGITUDE", "ELEVATION")])
stations <- list(stations, nb_na_tx, nb_na_tn, nb_na_tm) %>%
  reduce(full_join, by = "STATION")
aws <- list(aws, nb_na_tx, nb_na_tn, nb_na_tm) %>%
  reduce(full_join, by = "STATION")

# -- turn into a sf object to reproject CRS
stations <- st_as_sf(stations, coords = c("LONGITUDE", "LATITUDE"))
st_crs(stations) <- "EPSG:4326"
stations <- st_transform(stations, crs(nc_borders))
stations <- data.frame(stations)

datatable(stations, filter = "top")

# -- remove stations with >5 missing data
aws <- aws[which(aws$nb_na_tn <= 5 | aws$nb_na_tx <= 5), ]
```

Change aws dataframe projection

```{r, message=FALSE}
# -- turn into a sf object to reproject CRS
aws <- st_as_sf(aws, coords = c("LONGITUDE", "LATITUDE"))
st_crs(aws) <- "EPSG:4326"
aws <- st_transform(aws, crs(nc_borders))
aws <- data.frame(aws)
```

Function to extract a date in era5 TX and TN data.table

```{r}
era5_date <- function(day, era5, field) {
  era5_date <- era5[date == day]
  era5_date <- vect(era5_date, geom = c("lon", "lat"), crs = "EPSG:4326")
  empty_rast <- rast(
    nrows = 16, ncol = 41, extent = c(-85.12, -75.12, 33.30, 37.05),
    crs = "EPSG:4326"
  )
  era5_date <- rasterize(x = era5_date, y = empty_rast, field = field)
  era5_date <- project(era5_date, crs(nc_borders))
  return(era5_date)
}
```

#### Map several date examples

```{r}
date <- as.Date("2022-06-06")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-06-14")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina (very high TN)"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-06-20")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-07-26")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina (very high TN) "
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-07-30")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina (very high TN)"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-08-01")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)

date <- as.Date("2022-08-15")
my_map_raster_points(era5_date(date, era5_t2m, field = "TNwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMIN - 32) * 5 / 9,
  date = date, title = "TN North Carolina (low TN)"
)
my_map_raster_points(era5_date(date, era5_t2m, field = "TXwmo"),
  points = aws[which(aws$DATE == date), ],
  points.fill = (TMAX - 32) * 5 / 9,
  date = date, title = "TX North Carolina"
)
```

## Save as raster .tif

```{r}
empty_rast <- rast(
  nrows = 16, ncol = 41, extent = c(-85.12, -75.12, 33.30, 37.05),
  crs = "EPSG:4326"
)
date_vector <- as.character(unique(sort(era5_t2m$date)))
era5_tnwmo <- c()
era5_tn7am <- c()
era5_tn12am <- c()
era5_txwmo <- c()
era5_tx7am <- c()
era5_tx12am <- c()

for (d in date_vector) {
  era5_d <- era5_t2m[date == d]
  era5_d_vect <- vect(era5_d, geom = c("lon", "lat"), crs = "EPSG:4326")

  era5_d_rast_tnwmo <- rasterize(x = era5_d_vect, y = empty_rast,
                                 field = c("TNwmo"))
  era5_tnwmo <- c(era5_tnwmo, era5_d_rast_tnwmo)

  era5_d_rast_tn7am <- rasterize(x = era5_d_vect, y = empty_rast,
                                 field = c("TN7am"))
  era5_tn7am <- c(era5_tn7am, era5_d_rast_tn7am)

  era5_d_rast_tn12am <- rasterize(x = era5_d_vect, y = empty_rast,
                                  field = c("TN12am"))
  era5_tn12am <- c(era5_tn12am, era5_d_rast_tn12am)

  era5_d_rast_txwmo <- rasterize(x = era5_d_vect, y = empty_rast,
                                 field = c("TXwmo"))
  era5_txwmo <- c(era5_txwmo, era5_d_rast_txwmo)

  era5_d_rast_tx7am <- rasterize(x = era5_d_vect, y = empty_rast,
                                 field = c("TX7am"))
  era5_tx7am <- c(era5_tx7am, era5_d_rast_tx7am)

  era5_d_rast_tx12am <- rasterize(x = era5_d_vect, y = empty_rast,
                                  field = c("TX12am"))
  era5_tx12am <- c(era5_tx12am, era5_d_rast_tx12am)
}

era5_tnwmo <- rast(era5_tnwmo)
names(era5_tnwmo) <- date_vector

era5_tn7am <- rast(era5_tn7am)
names(era5_tn7am) <- date_vector

era5_tn12am <- rast(era5_tn12am)
names(era5_tn12am) <- date_vector

era5_txwmo <- rast(era5_txwmo)
names(era5_txwmo) <- date_vector

era5_tx7am <- rast(era5_tx7am)
names(era5_tx7am) <- date_vector

era5_tx12am <- rast(era5_tx12am)
names(era5_tx12am) <- date_vector

plot(era5_tnwmo[[1:4]])
plot(era5_tn12am[[1:4]])
plot(era5_tn7am[[1:4]])
plot(era5_txwmo[[1:4]])
plot(era5_tx12am[[1:4]])
plot(era5_tx7am[[1:4]])

writeRaster(era5_tnwmo,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_tnwmo.tif"),
  overwrite = TRUE
)
writeRaster(era5_txwmo,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_txwmo.tif"),
  overwrite = TRUE
)

writeRaster(era5_tn7am,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_tn7am.tif"),
  overwrite = TRUE
)
writeRaster(era5_tx7am,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_tx7am.tif"),
  overwrite = TRUE
)

writeRaster(era5_tn12am,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_tn12am.tif"),
  overwrite = TRUE
)
writeRaster(era5_tx12am,
  paste0(input_path, "era5_daily_reanalysis_20220601_20220831_tx12am.tif"),
  overwrite = TRUE
)
```

Session info

```{r}
sessionInfo()
```
