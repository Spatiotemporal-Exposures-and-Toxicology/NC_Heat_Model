---
title: "spatial machine learning"
output: html_document
date: "2023-09-11"
---

Libraries

```{r, message=F}
library(gstat)
library(terra)
library(sf)
library(sftime)
library(tidyverse)
library(ggplot2)
library(ggspatial)
library(gridExtra)
library(tidyterra)
library(rgeos)
library(data.table) # -- for large flat datasets
library(DT)

# -- for timeseries
library(lubridate)
library(xts)

# -- ml libraries
library(caret)
library(glmnet)
library(randomForest)

# -- code style
library(styler)
```

My own functions to manipulate data:

```{r}
source("functions_manipulate_spacetime_data.R")
source("functions_open_my_spacetime_data.R")
```

#### Open data on a specific period

```{r}
obs <- fread("../input/NC-monitors-dailysummary-20220601-20220831-space-time-covariates.csv")
nc_borders <- vect("../input/NC_county_boundary/North_Carolina_State_and_County_Boundary_Polygons.shp")

p <- seq(as.Date("2022-07-20"), as.Date("2022-07-22"), by = "1 day")
pred_p <- open_pred_period(p)
obs_p <- obs[date %in% p, ]
```

Define origin and destination projections

```{r}
crs_wgs84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
crs_nad83 <- crs_nad83 <- 'PROJCS["NAD83 / Conus Albers",
    GEOGCS["NAD83",
        DATUM["North_American_Datum_1983",
            SPHEROID["GRS 1980",6378137,298.257222101],
            TOWGS84[0,0,0,0,0,0,0]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4269"]],
    PROJECTION["Albers_Conic_Equal_Area"],
    PARAMETER["latitude_of_center",23],
    PARAMETER["longitude_of_center",-96],
    PARAMETER["standard_parallel_1",29.5],
    PARAMETER["standard_parallel_2",45.5],
    PARAMETER["false_easting",0],
    PARAMETER["false_northing",0],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["Easting",EAST],
    AXIS["Northing",NORTH],
    AUTHORITY["EPSG","5070"]]'
```

Project datatables lon and lat variables

```{r}
pred_p <- project_dt(pred_p, crs_wgs84, crs_nad83)
obs_p <- project_dt(obs_p, crs_wgs84, crs_nad83)
```

Add county to datatables

```{r}
pred_p <- add_nc_county(pred_p, crs_nad83)
obs_p <- add_nc_county(obs_p, crs_nad83)
```


```{r, eval=F}
obs_p$date <- as.Date(obs_p$date)
obs_p_sft <- st_as_sftime(obs_p,
  coords = c("lon", "lat"),
  remove = F,
  crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0",
  time_column_name = "date"
)
pred_p$date <- as.Date(pred_p$date)
pred_p_sft <- st_as_sftime(pred_p,
  coords = c("lon", "lat"),
  remove = F,
  crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0",
  time_column_name = "date"
)
#crs.meters <- "+proj=lcc +lat_0=33.75 +lon_0=-79 +lat_1=36.1666666666667 +lat_2=34.3333333333333 +x_0=609601.219202439 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
crs_nad83 <- 'PROJCS["NAD83 / Conus Albers",
    GEOGCS["NAD83",
        DATUM["North_American_Datum_1983",
            SPHEROID["GRS 1980",6378137,298.257222101],
            TOWGS84[0,0,0,0,0,0,0]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4269"]],
    PROJECTION["Albers_Conic_Equal_Area"],
    PARAMETER["latitude_of_center",23],
    PARAMETER["longitude_of_center",-96],
    PARAMETER["standard_parallel_1",29.5],
    PARAMETER["standard_parallel_2",45.5],
    PARAMETER["false_easting",0],
    PARAMETER["false_northing",0],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["Easting",EAST],
    AXIS["Northing",NORTH],
    AUTHORITY["EPSG","5070"]]'

nc_borders <- project(nc_borders, crs_nad83)
obs_p_sft <- st_transform(obs_p_sft, crs_nad83)
pred_p_sft <- st_transform(pred_p_sft, crs_nad83)

# -- store c(lon,lat) columns in crs.meters (instead of wgs84)
obs_p_sft <- obs_p_sft %>%
  mutate(
    lon = unlist(map(obs_p_sft$geometry, 1)),
    lat = unlist(map(obs_p_sft$geometry, 2))
  )

pred_p_sft <- pred_p_sft %>%
  mutate(
    lon = unlist(map(pred_p_sft$geometry, 1)),
    lat = unlist(map(pred_p_sft$geometry, 2))
  )
```

Before removing NA, reconvert to data.table to easily create STFDF

```{r, eval=F}
obs_p <- as.data.table(obs_p_sft)
obs_p <- obs_p[, geometry := NULL]
```

Remove NA in obs_p_sft

```{r}
obs_p_sft <- obs_p_sft[!is.na(obs_p_sft$tmin) & !is.na(obs_p_sft$tmax), ]
```

#### Residuals plot function

```{r}
gplot_res <- function(x, y, titre = "titre") {
  ggplot(data.frame(x = x, y = y), aes(x, y)) +
    geom_point(col = "blue", alpha = .5) +
    xlim(5, 30) +
    ylim(-10, 10) +
    ylab("Residuals") +
    xlab("Predicted values") +
    ggtitle(titre) +
    coord_equal() +
    geom_hline(yintercept = 0, col = "green")
}
```

#### Prepare train and test samples

Add county corresponding to each monitor location

```{r}
monitors <- unique(obs_p[, c("station", "lon", "lat")])
monitors <- vect(monitors, geom = c("lon", "lat"), crs = crs_nad83)
plot(monitors)
monitors$county <- terra::extract(nc_borders[, c("County")], monitors)$County
obs_p_sft <- merge(obs_p_sft, monitors[, c("station", "county")], by = c("station"))
obs_p <- merge(obs_p, monitors[, c("station", "county")], by = c("station"))
```

Create several types of train and test sets:

-   rdn_st: select randomly the observations in space and time

-   rdn_s: select randomly the stations (and keep the whole timeserie)

-   rdn_t: seperate train and test by dates (here: remove the last date of the dataset to evaluate capacity of prediction)

-   s.[area_name]: seperate train and test by selecting stations (and their entire timeserie) according to a contiguous area (group of counties). Several options are possible (test can be urban - mountain - piedmont - sea - plain).

-   net: select monitors per network. Reliable networks: ECONET, CRN, WBAN. Less reliable: COOP and RAWS.

```{r}
set.seed(111)
obs_p <- na.omit(obs_p)
test_ratio <- .2

# -- random spatially and temporally test_rnd_st
npop <- nrow(obs_p)
ntest_rnd_st <- ceiling(npop * test_ratio)
test_rnd_st_i <- sample(1:npop, ntest_rnd_st)
train_rnd_st_i <- setdiff(1:npop, test_rnd_st_i)
train_rnd_st <- obs_p[train_rnd_st_i, ]
test_rnd_st <- obs_p[test_rnd_st_i, ]
str(train_rnd_st)
str(test_rnd_st)

# -- random spatially but keep timeserie
monitors <- unique(obs_p$station)
n.mon <- length(monitors)
ntest_rnd_s <- ceiling(n.mon * test_ratio)
test_rnd_s_i <- sample(1:n.mon, ntest_rnd_s)
train_rnd_s_i <- setdiff(1:n.mon, test_rnd_s_i)
train_rnd_s <- obs_p[station %in% monitors[train_rnd_s_i], ]
test_rnd_s <- obs_p[station %in% monitors[test_rnd_s_i], ]
str(train_rnd_s)
str(test_rnd_s)

# -- random temporally but keep all monitors for each date in the training set
# -- (remove the last day of the period of length(p) days)
train_rnd_t <- obs_p[date %in% p[1:length(p) - 1], ]
test_rnd_t <- obs_p[date %in% p[length(p)], ]

# -- spatial selection (by group of county)
n_county <- dim(nc_borders)[1]
urban_c <- c("Durham", "Orange", "Chatham", "Wake")
# urban_c <- c("Mecklenburg")
mountain_c <- c("Wilkes", "Ashe", "Watauga", "Caldwell")
piedmont_c <- c("Rowan", "Davidson", "Davie", "Forsyth")
plain_c <- c("Wilson", "Edgecombe", "Nash", "Halifax")
sea_c <- c("Tyrrell", "Washington", "Dare", "Hyde")
train_s_urb <- obs_p[!(county %in% urban_c), ]
test_s_urb <- obs_p[county %in% urban_c, ]
train_s_mou <- obs_p[!(county %in% mountain_c), ]
test_s_mou <- obs_p[county %in% mountain_c, ]
train_s_pie <- obs_p[!(county %in% piedmont_c), ]
test_s_pie <- obs_p[county %in% piedmont_c, ]
train_s_pla <- obs_p[!(county %in% plain_c), ]
test_s_pla <- obs_p[county %in% plain_c, ]
train_s_sea <- obs_p[!(county %in% sea_c), ]
test_s_sea <- obs_p[county %in% sea_c, ]

# -- selection with network origin
train_net <- obs_p[!(network %in% c("ECONET", "CRN", "WBAN")), ]
test_net <- obs_p[network %in% c("ECONET", "CRN", "WBAN"), ]
```

Plot training et testing sample tile plots and maps

```{r}
df_test <- test_rnd_st
df_test$set <- "test"
df_train <- train_rnd_st
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile() +
  scale_fill_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on random observations") +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
  )
```

```{r}
df_test <- test_rnd_s
df_test$set <- "test"
df_train <- train_rnd_s
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile() +
  scale_fill_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on random monitors") +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
  )
```

```{r}
df_test <- test_rnd_t
df_test$set <- "test"
df_train <- train_rnd_t
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile() +
  scale_fill_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on last day") +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
  )
```

```{r}
df_test <- test_s_urb
df_test$set <- "test"
df_train <- train_s_urb
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile() +
  scale_fill_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on urban county") +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
  )
ggplot(df, aes(x = lon, y = lat, color = set)) +
  geom_point() +
  scale_color_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on urban counties") +
  coord_equal()
```

```{r}
df_test <- test_s_mou
df_test$set <- "test"
df_train <- train_s_mou
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile() +
  scale_fill_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on mountain counties") +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank()
  )
ggplot(df, aes(x = lon, y = lat, color = set)) +
  geom_point() +
  scale_color_manual(values = c("train" = "lightblue", test = "tomato4")) +
  labs(title = "Test on mountain counties") +
  coord_equal()
```

```{r}
df_test <- test_s_pie
df_test$set <- "test"
df_train <- train_s_pie
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile()+
  scale_fill_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on Piedmont counties")+
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank()
    )  
ggplot(df, aes(x = lon, y = lat, color = set)) +
  geom_point()+
  scale_color_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on Piedmont counties")+
  coord_equal()
```

```{r}
df_test <- test_s_pla
df_test$set <- "test"
df_train <- train_s_pla
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile()+
  scale_fill_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on plain counties")+
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank()
    )  
ggplot(df, aes(x = lon, y = lat, color = set)) +
  geom_point()+
  scale_color_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on plain counties")+
  coord_equal()
```

```{r}
df_test <- test_s_sea
df_test$set <- "test"
df_train <- train_s_sea
df_train$set <- "train"
df <- rbind(df_train, df_test)
ggplot(df, aes(y = station, x = as.Date(date), fill = set)) +
  geom_tile()+
  scale_fill_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on sea counties")+
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank()
    )  
ggplot(df, aes(x = lon, y = lat, color = set)) +
  geom_point()+
  scale_color_manual(values=c("train"="lightblue", test="tomato4"))+
  labs(title="Test on sea counties")+
  coord_equal()
```

## Linear regression

Check gaussian distribution

```{r}
ggplot(obs_p) +
  geom_histogram(aes(tmin), binwidth = 1) +
  xlim(9, 30)

ggplot(obs_p) +
  geom_histogram(aes(tcc), binwidth = 10)

ggplot(obs_p) +
  geom_histogram(aes(log(tcc)))

ggplot(obs_p) +
  geom_histogram(aes(dem), binwidth = 100)

ggplot(obs_p) +
  geom_histogram(aes(log(dem)))

ggplot(obs_p) +
  geom_histogram(aes(-log(imp)))

ggplot(obs_p) +
  geom_histogram(aes(imp))

ggplot(obs_p) +
  geom_histogram(aes(TN12am), binwidth = 1) +
  xlim(9, 30)
```

```{r}
reg.lm <- aov(tmin ~ TN12am, data = train_rnd_st)
res.lm <- reg.lm$residuals
fit.lm <- reg.lm$fitted.values
gplot_res(fit.lm, res.lm, "ANCOVA without covariate selection")
coef(reg.lm)
```

```{r}
reg.lm <-aov(tmin ~ TN12am + tcc + dem + imp + build.h + build.fp , data = train_rnd_st)
res.lm <- reg.lm$residuals
fit.lm <- reg.lm$fitted.values
gplot_res(fit.lm, res.lm, "ANCOVA without covariate selection")
coef(reg.lm)
```

Regression shrinkage methods

```{r}
reg.lasso.quanti <- glmnet(y = train_rnd_st$tmin, x = as.matrix(train_rnd_st[, c("tcc", "imp", "build.fp", "dem", "TN12am")]))
plot(reg.lasso.quanti, xvar = "lambda", label = TRUE)
legend(x=-4, y=0.4,legend = paste(1:5, " - ", c("tcc", "imp", "build.fp", "dem", "TN12am")), cex = .4)

x.mat <- model.matrix(tmin ~ . - 1, data = train_rnd_st[, c("tmin", "tcc", "imp", "build.fp", "build.h", "dem", "TN12am")])
reg.lasso <- glmnet(y = train_rnd_st$tmin, x = x.mat)
options(repr.plot.width = 12, repr.plot.height = 10)
plot(reg.lasso, xvar = "lambda", label = TRUE)
legend(x=-1, y=2,legend = paste(1:ncol(x.mat), " - ", colnames(x.mat)), cex = .4)
```

Optimum for log(lambda) : two covariates (TN12am and dem)

```{r}
reg.lasso_cv <- cv.glmnet(y = train_rnd_st$tmin, x = as.matrix(train_rnd_st[, c("tcc", "imp", "build.fp", "dem", "TN12am")]))
plot(reg.lasso_cv)
```

```{r}
paste("CV estimate of lambda :", round(reg.lasso_cv$lambda.1se, 3))
coef(reg.lasso_cv, s = "lambda.1se")
```

```{r}
fit.lasso.1se <- predict(reg.lasso_cv, s = "lambda.1se", newx = as.matrix(train_rnd_st[, c("tcc", "imp", "build.fp", "dem", "TN12am")]))
res.lasso.1se <- train_rnd_st$tmin - fit.lasso.1se 

# Graphe des résidus
options(repr.plot.width = 12, repr.plot.height = 4)
par(mfrow = c(1, 3))
gplot_res(fit.lm, res.lm, "Linéaire, sans sélection")
gplot_res(fit.lasso.1se, res.lasso.1se, "Linéaire, pénalité L1, lambda 1se") 
```

```{r}
paste("Without coef shrinkage MSE:",mean(res.lm^2))
paste("LASSO with lambda.1se:",mean(res.lasso.1se^2))
```

10-fold CV mean square error

```{r}
V <- 10 
nV <- floor(nrow(train_rnd_st)/V)
S <- sample(1:nrow(train_rnd_st), replace=FALSE)
error.CV = c()
for(v in 1:V){
    train_rnd_st.learn <- train_rnd_st[-c(S[(nV*(v-1)):(nV*v)]),] 
    train_rnd_st.valid <- train_rnd_st[c(S[(nV*(v-1)):(nV*v)]),]
    error.CV <- c(error.CV, mean((train_rnd_st.valid$tmin-predict(aov(tmin ~ tcc + imp + build.fp + dem + TN12am, data=train_rnd_st.learn), newdata=train_rnd_st.valid))^2))
}
mean(error.CV)
print(reg.lasso_cv)
```

Quadratic model (AIC criteria model selection)

```{r}
reg.glm <- glm(tmin ~ .^2, data = train_rnd_st[, c("tmin", "tcc", "imp", "build.fp", "dem", "TN12am")])


reg.glm_step <- step(reg.glm, direction = "backward")
anova(reg.glm_step, test_rnd_st = "F")   
```

LASSO (L1 shrinkage)

```{r}
x.mat2 <- model.matrix(tmin ~ .^2 - 1, data = train_rnd_st[, c("tmin", "tcc", "imp", "build.fp", "dem", "TN12am")])
reg.lasso2 <- glmnet(y = train_rnd_st$tmin, x = x.mat2)
reg.lasso2_cv <- cv.glmnet(y = train_rnd_st$tmin, x = x.mat2)
coef(reg.lasso2_cv, s = "lambda.1se")
```

```{r}
fit.glm <- reg.glm_step$fitted.values 
res.glm <- reg.glm_step$residuals
fit.lasso2_cv <- predict(reg.lasso2_cv, s = "lambda.min", newx = x.mat2)
res.lasso2_cv <- train_rnd_st$tmin - fit.lasso2_cv

# Graphe des résidus
g1<-gplot_res(fit.lm, res.lm, "linéaire")
g2<-gplot_res(fit.lasso.1se, res.lasso.1se, "linéaire, pénalité L1")
g3<-gplot_res(fit.glm, res.glm, "quadratique, backward AIC")
g4<-gplot_res(fit.lasso2_cv, res.lasso2_cv, "quadratique, pénalité L1")
grid.arrange(g1,g2,g3,g4,ncol=2,nrow=2)
```

test_rnd_st sample predictions

```{r}
test_rnd_st$glm.pred <- predict(reg.glm_step, newdata = test_rnd_st)
test_rnd_st$glm.res <- test_rnd_st$glm.pred - test_rnd_st$tmin
sum((test_rnd_st$glm.res)^2) / nrow(test_rnd_st)
```

Grid prediction

```{r}
pred_p$glm.pred <- predict(reg.glm_step, newdata = pred_p)
```

Select and plot a specific date

```{r}
d <- "2022-07-20"
plot.pred <- pred_p[pred_p$date==d,] 
plot.pred <- st_as_sf(plot.pred, 
                    coords=c("lon", "lat"),
                    remove=F,
                    crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
plot.pred <- vect(plot.pred)

m <- ggplot() +
  geom_spatvector(data = plot.pred, aes(color=glm.pred), size=.1) +
  #geom_sf(data = obs_p, aes(geometry=geometry, color=tmin)) +
  geom_sf(data = st_as_sf(nc_borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  scale_color_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "°C"),
      n.breaks = 12,
      guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "Generalized Linear Model"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot_caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
m
```

#### Compare results on different definitions of train - test

Results with LASSO regression on quadratic covariates

```{r}
x.mat2 <- model.matrix(tmin ~ .^2 - 1, data = train_rnd_st[, c("tmin", "tcc", "imp", "build.fp", "dem", "TN12am")])
x.mat2.test <- model.matrix(tmin ~ .^2 - 1, data = test_rnd_st[, c("tmin", "tcc", "imp", "build.fp", "dem", "TN12am")])

reg.lasso2 <- glmnet(y = train_rnd_st$tmin, x = x.mat2)
test_rnd_st$lasso2.pred <- predict(reg.lasso2, newx = x.mat2.test, s=0.1)

test_rnd_st$lasso2.res <- test_rnd_st$lasso2.pred - test_rnd_st$tmin
sum((test_rnd_st$lasso2.res)^2) / nrow(test_rnd_st)
pred_p$lasso2.rdn_st.pred <- predict(reg.lasso2, newdata = pred_p)
```

## Random Forest

```{r}
rf.reg <- randomForest(
  tmin ~ tcc + imp + build.fp + build.h + dem + TN12am, 
  data=train_rnd_st, 
  xtest_rnd_st=test_rnd_st[, .(tcc,imp,build.fp,build.h,dem,TN12am)], 
  ytest_rnd_st=test_rnd_st$tmin,
  ntree=500, mtry=2, do.trace=50, importance=TRUE)
attributes(rf.reg)
rf.reg$mtry
```

```{r}
fit.rf=rf.reg$predicted
res.rf=fit.rf-train_rnd_st$tmin
gplot_res(fit.rf,res.rf,titre="")
```

Variable importance

```{r}
rf.reg$importance
varImpPlot(rf.reg)
library(ggRandomForests)
plot(gg_vimp(rf.reg))
```

On test_rnd_st sample

```{r}
test_rnd_st$rf.pred <- predict(rf.reg, newdata = test_rnd_st)
#test_rnd_st$rf.pred <- rf.reg$test_rnd_st$predicted
test_rnd_st$rf.res <- test_rnd_st$rf.pred - test_rnd_st$tmin
sum((test_rnd_st$rf.res)^2)/nrow(test_rnd_st)
```

Prediction on the grid

```{r}
pred.rf.grid <- predict(object=rf.reg, newdata = pred_p)
pred_p$rf.pred <- pred.rf.grid 
```

```{r}
d <- "2022-07-20"
plot.pred <- pred_p[pred_p$date==d,] 
plot.pred <- st_as_sf(plot.pred, 
                    coords=c("lon", "lat"),
                    remove=F,
                    crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
plot.pred <- vect(plot.pred)

m <- ggplot() +
  geom_spatvector(data = plot.pred, aes(color=rf.pred), size=.1) +
  #geom_sf(data = obs_p, aes(geometry=geometry, color=tmin)) +
  geom_sf(data = st_as_sf(nc_borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  scale_color_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "°C"),
      n.breaks = 12,
      guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "Generalized Linear Model"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot_caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
m
```

#### Gradient Boosting

```{r}

```

#### Neural networks

```{r}

```

## Kriging on residuals

-   compute predictions on test_rnd_st set

-   plot empirical variogram of residuals on validation set to see if there is a spatio-temporal pattern

-   fit

#### Variogram analysis

Tranform test_rnd_st set to a STFDF object from spacetime library

```{r}
library(spacetime)
test_rnd_st <- test_rnd_st[, ":="(date=as.Date(date)),]
test_rnd_st_st <- stConstruct(as.data.frame(test_rnd_st), space=c("lon","lat"), time="date", 
                       SpatialObj=SpatialPoints(test_rnd_st[,c("lon","lat")]), 
                       crs=CRS(crs_nad83))
test_rnd_st_st <- as(test_rnd_st_st,"STFDF")
```

Plot residulals for one date

Plot residuals evolution per one location

```{r, eval=FALSE}
ggplot(test_rnd_st[which(test_rnd_st$station %in% unique(test_rnd_st$station)[1:10]),])+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  theme(legend.position="none")


ggplot(test_rnd_st[which(test_rnd_st$network=="ECONET"),])+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  ylim(-5,5)+
  theme(legend.position="none")

ggplot(test_rnd_st[which(test_rnd_st$network=="RAWS"),])+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  ylim(-5,5)+
  theme(legend.position="none")

ggplot(test_rnd_st[which(test_rnd_st$network=="WBAN"),])+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  ylim(-5,5)+
  theme(legend.position="none")

ggplot(test_rnd_st[which(test_rnd_st$network=="COOP"),])+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  ylim(-5,5)+
  theme(legend.position="none")

ggplot(test_rnd_st)+
  geom_line(aes(x=date, y=glm.res, color=station, group=station))+
  geom_point(aes(x=date, y=glm.res, color=station, group=station))+
  facet_wrap(vars(network))+
  ylim(-5,5)+
  theme(legend.position="none")


ggplot(test_rnd_st)+
  geom_point(aes(x=lon, y=lat, color=glm.res))+
  geom_point(data=train_rnd_st, aes(x=lon, y=lat), shape=3, color="grey")+
  facet_wrap(vars(date))+
  scale_color_steps2(low="blue", mid="white", high="red", limits=c(-3,3), n.breaks=10)

```

Directions: 0=north, 90=east, 180=south, 270=west

```{r, eval=F}
cutoff=30000 
width=1000
plot(variogram(rf.res ~ 1, data=test_rnd_st_st, cloud = TRUE, cutoff=cutoff, width=width), tlags=0:3, main="semivariogram cloud residuals RF")


plot(variogram(glm.res ~ 1, test_rnd_st_st, cloud = TRUE, cutoff=10000, width=width), main="semivariogram cloud residuals glm")

plot(variogram(tmin ~ 1, obs.d, cutoff=cutoff, width=width), main="sample semivariogram")
plot(variogram(tmin ~ 1, obs.d, cutoff=cutoff, width=width, alpha = c(0, 45, 90, 135, 180, 225, 270, 315)), main="direction dependance")

```

Variogram model

```{r, eval=F}
cutoff <- 100000
v.emp <- variogram(tmin ~ 1, obs.d, cutoff=cutoff, width=width)

nugget <- 0.5
range <- 20000
vgm.sph <- vgm(psill=3, "Sph", range=range, nugget=0.5, cutoff=cutoff)
plot(v.emp, vgm.sph, cutoff=cutoff)

vgm.exp <- vgm(psill=3, "Exp", range=range, nugget=0.5, cutoff=cutoff)
plot(v.emp, vgm.exp, cutoff=cutoff)

vgm.mat <- vgm(psill=3, "Mat", range=range, nugget=0.5, cutoff=cutoff)
plot(v.emp, vgm.mat, cutoff=cutoff)
```

Fit Matern model

```{r, eval=F}
v.fit <- fit.variogram(v.emp, vgm.mat, fit.range=F)
plot(v.emp, v.fit)
```

#### Ordinary kriging on residuals

```{r, eval=F}
cutoff <- 100000
nugget <- 0.5
range <- 20000
width <- 1000
v.emp <- variogram(tmin ~ 1, obs.d, cutoff=cutoff, width=width)
vgm.mat <- vgm(psill=3, "Mat", range=range, nugget=nugget, cutoff=cutoff)
v.fit <- fit.variogram(v.emp, vgm.mat, fit.range=F)
ok <- gstat::krige(tmin ~ 1, obs.d, newdata=pred.d, v.fit)
```

```{r, eval=F}
m <- ggplot() +
  geom_spatvector(data = vect(ok), aes(color=var1.pred), size=.1) +
  geom_sf(data = obs.d, aes(geometry=geometry, color=tmin)) +
  geom_sf(data = st_as_sf(nc_borders), aes(geometry=geometry), 
               colour = "grey", linewidth=.3, fill = NA) +
  scale_color_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "°C"),
      n.breaks = 12,
      guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "Ordinary kriging"
  ) +
  annotation_scale(
    location="bl", pad_x = unit(1, "cm"), 
		pad_y = unit(1, "cm"), 
		height = unit(0.30, "cm"), 
		text_cex = 1
	) +
	annotation_north_arrow(
	  location = "br", 
	  which_north = "true", 
		pad_x = unit(0.2, "cm"), 
		pad_y = unit(0.2, "cm")
	) +
	theme(
			axis.text = element_text(size=12, family="serif"),
			plot_caption = element_text(size=10, family="serif"),
			legend.text = element_text(size=12, family="serif"),
			legend.title = element_text(size=12, family="serif"),
			panel.background = element_rect(fill = "white"),
			panel.grid.major=element_line(colour="grey")
		)
m
```

#### 
